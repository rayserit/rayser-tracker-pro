<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Libreria di Gioco</title>
  <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NDAgNTEyIj48cGF0aCBmaWxsPSIjM0E4NkZGIiBkPSJNNjAzLjkgMTM1LjVjLTYxLTQxLjgtMTMyLjQtNTQuNy0yMDAtNTQuN0gzMzJjLTYwIDAtMTE1LjggMTIuOS0xNzIgNDItMTggOS43LTMxLjYgMjIuMS00MC42IDM2LjJDNTEuMyAyMTEuMyA0OCAyNTkuNyA0OCAyOTZjMCA0MS40IDIyLjEgODIgNjAuMSA5Ny4xYy0xLjggNC45LTIuOSAxMC4yLTIuOSAxNS44YzAgMTcuNyAxNC4zIDMyIDMyIDMySDM2YzAtNDQtMzYtODAtMzYtODBjMC0zNi40IDQuNC04My4yIDQyLjktMTI2LjRDMTEwLjYgNjEuNiAxNzQuMSAzMiAzMzIgMzJIMTQwYy3LjUgMC0xIDAtMS42IDBjNzYuMyAwIDE0Ny44IDE1LjcgMjA3LjIgNTguOEM0MTggMTI3LjkgNDc5LjEgMTI5IDU0NCAxMjljNzAuNyAwIDEzMi4zLTEuNSAxOTIuNSAxNEM3MzYgMTQ2LjUgNzM2IDEzMiA3MzYgMTMyYzAtNTIuOS00My4xLTk2LTk2LTk2aC0xNWMtMzUuMyAwLTY0IDI4LjctNjQgNjRjMCAyNy4zIDE3LjMgNTEgNDEuNSA2MC4xek01NDQgMzUyYzIxLjIgMCA0MS03LjcgNTYtMjAuNWMxMy42LTEyIDIzLjItMjguMSAyMy4yLTQ1LjVDNjIzLjIgMjQ2IDI3My40IDY0IDMyMCA2NGgtNjRjLTQ0LjIgMC04MCAzNS44LTgwIDgwYzAgMzUuMyAyOC43IDY0IDY0IDY0SDRjLTguOCAwLTE2IDcuMi0xNiAxNnY0YzAgNDQuMiAzNS44IDgwIDgwIDgwaDE0NGMxNy43IDAgMzItMTQuMyAzMi0zMmMwLTE3LjctMTQuMy0zMi0zMi0zMmgtNHYtNjRoMTZ2NjRoMzJ2LTY0aDE2djY0aDMyVjI4OGgxNnY2NGgzMlYyODhoMzJjMTMuMyAwIDI1LjIgNS4zIDM0IDIxLjRjMy42IDYuNiA1LjQgMTQuMiA1LjQgMjIuNmMwIDE3LjctOC45IDMzLjEtMjIuNyA0NC40bC0xMS4yIDkuMnptLTI1MC02NGMtOC44IDAtMTYgNy4yLTE2IDE2djE2aC0xNmMtOC44IDAtMTYgNy4yLTE2IDE2djMyYzAgOC44IDcuMiAxNiAxNiAxNmgxNnYxNmMwIDguOCA3LjIgMTYgMTYgMTZjOC44IDAgMTYtNy4yIDE2LTE2di0xNmgxNmM4LjggMCAxNi03LjIgMTYtMTZ2LTMyYzAtOC44LTcuMi0xNi0xNi0xNmgLTE2di0xNmMwLTguOC03LjItMTYtMTYtMTZ6bTMyIDE3NmMtMTMuMyAwLTI0IDguOS0yNCAyMHMxMC43IDI0IDI0IDI0czI0LTEwLjcgMjQtMjRzLTEwLjctMjQtMjQtMjR6bS0xNDQgMGMtMTMuMyAwLTI0IDEwLjctMjQgMjRzMTAuNyAyNCAyNCAyNHMyNC0xMC43IDI0LTI0cy0xMC43LTI0LTI0LTI0eiIvPjwvc3ZnPg==" type="image/svg+xml">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <style>
    :root { --primary: #3A86FF; --secondary: #00B4D8; --game-bg: #1e1e1e; --card-radius: 8px; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; padding: 1.5rem; background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); color: #f5f5f5; }
    .header { text-align: center; margin-bottom: 2rem; }
    .header h1 { color: var(--primary); }
    .header .user-email { font-size: 1.2rem; color: #aaa; }
    .section-title { font-size: 1.5rem; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 0.5rem; margin-bottom: 1.5rem; }
    .game-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .game { background: var(--game-bg); border-radius: var(--card-radius); overflow: hidden; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,.25); }
    .game img { width: 100%; display: block; }
    .game .title { padding: 0.75rem; font-size: 0.9rem; text-align: center; background: rgba(0,0,0,0.3); }
    .platinum-icon { position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; filter: drop-shadow(0 0 3px black); }
    #loading { text-align: center; font-size: 1.5rem; padding: 4rem 0; }
    .loading-spinner { border: 4px solid rgba(255,255,255,.1); border-radius: 50%; border-top: 4px solid var(--primary); width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div class="header">
    <h1>Libreria di <span id="userEmail" class="user-email">...</span></h1>
  </div>

  <div id="loading">
    <div class="loading-spinner"></div>
    <p>Caricamento libreria in corso...</p>
  </div>

  <div id="libraryContent" style="display: none;">
    <h2 class="section-title">Giochi in Corso</h2>
    <div class="game-grid" id="currentGrid"></div>
    <h2 class="section-title">Backlog</h2>
    <div class="game-grid" id="backlogGrid"></div>
    <h2 class="section-title">Completati</h2>
    <div class="game-grid" id="completedGrid"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDm946nISfZs8ugkuYPraNTzFhvgQmnMUk",
      authDomain: "gametrackerdb.firebaseapp.com",
      databaseURL: "https://gametrackerdb-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gametrackerdb",
      storageBucket: "gametrackerdb.firebasestorage.app",
      messagingSenderId: "132133020733",
      appId: "1:132133020733:web:acf5dd7301771aaffa3654"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const PLATINUM_ICON_URL = "https://i.psnprofiles.com/guides/18274/470bd2.png";

    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('user');

      if (!userId) {
        document.getElementById('loading').innerHTML = '<h1>ID utente non specificato.</h1>';
        return;
      }

      database.ref(`users/${userId}/gameTracker`).once('value').then(snapshot => {
        const data = snapshot.val();
        if (!data || !data.games) {
          document.getElementById('loading').innerHTML = '<h1>Libreria non trovata o vuota.</h1>';
          return;
        }

        const userEmail = data.gameStates.userEmail || userId.substring(0, 8) + '...';
        document.getElementById('userEmail').textContent = userEmail;
        
        const games = data.games;
        const gameStates = data.gameStates || {};
        
        games.sort((a,b) => {
            const keyA = a.title.toLowerCase().replace(/[^a-z0-9]/gi, "-");
            const keyB = b.title.toLowerCase().replace(/[^a-z0-9]/gi, "-");
            const timestampA = parseInt(gameStates[`lastPlayed_${keyA}`]) || 0;
            const timestampB = parseInt(gameStates[`lastPlayed_${keyB}`]) || 0;
            return timestampB - timestampA;
        });

        games.forEach(game => {
          const gameKey = game.title.toLowerCase().replace(/[^a-z0-9]/gi, "-");
          const isCurrent = gameStates['current_' + gameKey] === 'true';
          const isPlayed = gameStates['played_' + gameKey] === 'true';
          const hasPlatinum = gameStates['platinum_' + gameKey] === 'true';
          const imageUrl = gameStates['image_' + gameKey] || game.image;

          const gameElement = document.createElement('div');
          gameElement.className = 'game';
          gameElement.innerHTML = `
            ${hasPlatinum ? `<img src="${PLATINUM_ICON_URL}" class="platinum-icon" alt="Platino"/>` : ''}
            <img src="${imageUrl}" alt="${game.title}" onerror="this.style.display='none'">
            <div class="title">${game.title}</div>
          `;

          if (isCurrent) {
            document.getElementById('currentGrid').appendChild(gameElement);
          } else if (isPlayed) {
            document.getElementById('completedGrid').appendChild(gameElement);
          } else {
            document.getElementById('backlogGrid').appendChild(gameElement);
          }
        });

        document.getElementById('loading').style.display = 'none';
        document.getElementById('libraryContent').style.display = 'block';

      }).catch(error => {
        console.error("Errore nel recupero dati:", error);
        document.getElementById('loading').innerHTML = '<h1>Si Ã¨ verificato un errore nel caricamento della libreria.</h1>';
      });
    });
  </script>
</body>
</html>
