<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GameTracker Pro</title>
  <!-- Add Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <style>
    /* Added: Global box-sizing to prevent padding/border issues */
    *, *:before, *:after {
      box-sizing: border-box;
    }

    :root {
      --primary: #3A86FF;
      --secondary: #00B4D8;
      --danger: #ff4444;
      --success: #228b22;
      --warning: #ffcc00;
      --backlog-bg: #F5F5F5;
      --completed-bg: #e9ecef;
      --current-highlight: rgba(58, 134, 255, 0.1);
      --card-radius: 8px;
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      --cover-width: 180px;
      --cover-height: 240px;
      --cover-compact-width: 150px;
      --cover-compact-height: 200px;
      --game-bg: white;
      --menu-bg: white;
      --menu-hover: #f0f0f0;
      --divider-color: #eee;
      --text-primary: #333;
      --text-secondary: #666;
    }
    
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f8f9fa;
      color: var(--text-primary);
      transition: var(--transition);
      line-height: 1.6;
    }
    
    body.dark {
      background: #121212;
      color: #f5f5f5;
      --backlog-bg: #1a1a1a;
      --completed-bg: #2d2d2d;
      --current-highlight: rgba(58, 134, 255, 0.2);
      --game-bg: #1e1e1e;
      --menu-bg: #2d2d2d;
      --menu-hover: #3a3a3a;
      --divider-color: #444;
      --text-primary: #f5f5f5;
      --text-secondary: #aaa;
    }

    /* Auth Modal Styles */
    .auth-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .auth-modal.active {
      opacity: 1;
      visibility: visible;
    }
    
    .auth-container {
      background: var(--game-bg);
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
      padding: 2rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    
    .auth-modal.active .auth-container {
      transform: translateY(0);
    }
    
    .auth-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    
    .auth-header h2 {
      color: var(--primary);
      margin-bottom: 0.5rem;
    }
    
    .auth-tabs {
      display: flex;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--divider-color);
    }
    
    .auth-tab {
      flex: 1;
      text-align: center;
      padding: 0.75rem;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-secondary);
      transition: all 0.2s ease;
      border-bottom: 2px solid transparent;
    }
    
    .auth-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    
    .auth-form {
      display: none;
    }
    
    .auth-form.active {
      display: block;
    }
    
    .auth-form-group {
      margin-bottom: 1rem;
    }
    
    .auth-form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text-primary);
    }
    
    .auth-form-group input {
      width: 100%;
      padding: 0.75rem;
      border-radius: 8px;
      border: 1px solid var(--divider-color);
      background: var(--backlog-bg);
      color: var(--text-primary);
      font-size: 1rem;
      transition: all 0.2s ease;
    }
    
    .auth-form-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.2);
    }
    
    .auth-submit-btn {
      width: 100%;
      padding: 0.75rem;
      border-radius: 8px;
      background: var(--primary);
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      margin-top: 1rem;
      transition: all 0.2s ease;
    }
    
    .auth-submit-btn:hover {
      background: #2a75e6;
      transform: translateY(-1px);
    }
    
    .auth-footer {
      text-align: center;
      margin-top: 1.5rem;
      color: var(--text-secondary);
    }
    
    .auth-footer a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
    }
    
    .auth-error {
      color: var(--danger);
      font-size: 0.9rem;
      margin-top: 0.5rem;
      text-align: center;
    }
    
    .auth-success {
      color: var(--success);
      font-size: 0.9rem;
      margin-top: 0.5rem;
      text-align: center;
    }
    
    .auth-loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    .user-profile {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      text-transform: uppercase;
    }
    
    .user-email {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    .logout-btn {
      background: none;
      border: none;
      color: var(--danger);
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem;
      margin-left: auto;
    }
    
    h1, h2, h3 {
      margin-top: 0;
      font-weight: 600;
    }

    h1 {
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: 2rem;
      color: var(--primary);
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .header-left {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      flex-grow: 1;
    }

    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .compact-stats {
      display: flex;
      gap: 0.5rem;
      background: rgba(58, 134, 255, 0.08);
      border-radius: 12px;
      padding: 0.5rem;
      border: 1px solid rgba(58, 134, 255, 0.1);
      margin-bottom: 1rem;
    }

    .stat-item {
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      background: rgba(58, 134, 255, 0.05);
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 60px;
    }

    .stat-item:hover {
      background: rgba(58, 134, 255, 0.1);
    }

    .stat-value {
      font-weight: 800;
      color: var(--primary);
      font-size: 1.1rem;
    }

    .stat-label {
      font-size: 0.7rem;
      opacity: 0.8;
      text-align: center;
    }

    .controls-row {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
      width: 100%;
    }

    .filter-controls {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      max-width: 240px;
    }

    .search-container {
      position: relative;
      flex: 1 1 200px;
      min-width: 150px;
      max-width: 250px;
    }

    #gameSearch {
      width: 100%;
      padding: 0.7rem 1rem 0.7rem 2.5rem;
      border-radius: 8px;
      border: none;
      font-size: 0.95rem;
      transition: var(--transition);
      background-position: 1rem center;
      background-repeat: no-repeat;
      background-size: 1rem;
    }
    
    body.light #gameSearch {
      background-color: #f5f5f5;
      color: #333;
      border: 1px solid #e0e0e0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
    }
    
    body.light #gameSearch:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.2);
      background-color: white;
    }
    
    body.dark #gameSearch {
      background-color: #2a2a2a;
      color: #f5f5f5;
      border: 1px solid #444;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23aaa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
    }
    
    body.dark #gameSearch:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.3);
      background-color: #333;
    }

    #sortSelect {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding: 0.7rem 2.5rem 0.7rem 1rem;
      border-radius: 8px;
      border: none;
      font-size: 0.95rem;
      cursor: pointer;
      transition: var(--transition);
      background-position: right 1rem center;
      background-repeat: no-repeat;
      background-size: 1rem;
      flex: 0 1 150px;
    }

    body.light #sortSelect {
      background-color: #f5f5f5;
      color: #333;
      border: 1px solid #e0e0e0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    }

    body.light #sortSelect:hover {
      background-color: #eee;
    }

    body.dark #sortSelect {
      background-color: #2a2a2a;
      color: #f5f5f5;
      border: 1px solid #444;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23aaa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    }

    body.dark #sortSelect:hover {
      background-color: #333;
    }

    #sortSelect:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.2);
    }

    .theme-toggle {
      width: 42px;
      height: 42px;
      min-width: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      padding: 0;
      border-radius: 50%;
      flex: 0 0 42px;
    }

    .theme-toggle:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    .games-section {
      margin-bottom: 2rem;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--primary);
      position: relative;
    }

    .section-header::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 100px;
      height: 2px;
      background: var(--secondary);
    }

    .section-title {
      font-size: 1.4rem;
      color: var(--primary);
      margin: 0;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .game-count {
      background: var(--primary);
      color: white;
      padding: 0.35rem 0.9rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    .current-section {
      background: var(--current-highlight);
      border-radius: var(--card-radius);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .current-grid,
    .game-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(var(--cover-width), 1fr));
      gap: 1.5rem;
    }

    .game {
      background: var(--game-bg);
      border-radius: var(--card-radius);
      overflow: hidden;
      transition: var(--transition);
      position: relative;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      width: var(--cover-width);
      border: 1px solid rgba(0,0,0,0.05);
      animation: fadeIn 0.3s ease forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    body.dark .game {
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      border-color: rgba(255,255,255,0.05);
    }

    .current-section .game {
      border-top: 3px solid var(--primary);
    }

    .backlog-column .game {
      border-top: 3px dashed #aaa;
    }

    .completed-column .game {
      border-top: 3px solid #00B4D8;
    }

    .game:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }

    .banner {
      width: 100%;
      height: var(--cover-height);
      object-fit: cover;
      object-position: center top;
      cursor: pointer;
      transition: transform 0.3s ease;
      background: linear-gradient(45deg, #1a1a1a, #333);
      position: relative;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
    }

    .banner::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 40%;
      background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .game:hover .banner::after {
      opacity: 1;
    }

    .info {
      padding: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .game-title {
      font-weight: 600;
      flex-grow: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 0.9rem;
    }

    .remove-btn, .copy-btn, .move-btn {
      position: absolute;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      border: none;
      cursor: pointer;
      opacity: 0;
      transition: var(--transition);
      top: 10px;
      font-size: 0.8rem;
    }

    .remove-btn {
      right: 10px;
      background: var(--danger);
      color: white;
    }

    .copy-btn {
      left: 10px;
      background: var(--secondary);
      color: white;
    }
    
    .move-btn {
      left: 46px;
      background: var(--primary);
      color: white;
      font-size: 14px;
    }

    .game:hover .remove-btn,
    .game:hover .copy-btn,
    .game:hover .move-btn {
      opacity: 1;
    }

    input[type="checkbox"] {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border: 2px solid var(--primary);
      border-radius: 4px;
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
    }

    input[type="checkbox"]:checked {
      background-color: var(--primary);
    }

    input[type="checkbox"]:checked::after {
      content: '✓';
      position: absolute;
      color: white;
      font-size: 12px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    body.light input[type="checkbox"]:checked + .game-title {
      color: var(--success);
    }

    body.dark input[type="checkbox"]:checked + .game-title {
      color: #4CAF50;
    }

    .platinum-icon {
      width: 18px;
      height: 18px;
      filter: drop-shadow(0 0 2px rgba(0,0,0,0.3));
    }

    .context-menu {
      position: fixed;
      background: var(--menu-bg);
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      width: 220px;
      display: none;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.1);
      backdrop-filter: blur(5px);
      background: rgba(var(--menu-bg-rgb), 0.9);
    }
    
    body.dark .context-menu {
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      border-color: rgba(255,255,255,0.1);
    }
    
    .context-menu-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.9rem;
    }
    
    .context-menu-item:hover {
      background: var(--menu-hover);
    }
    
    .context-menu-divider {
      height: 1px;
      background: var(--divider-color);
      margin: 0.25rem 0;
    }

    .game.dragging {
      opacity: 0.5;
      transform: scale(0.95);
    }
    
    .drop-zone {
      transition: background-color 0.3s;
      min-height: 100px;
    }
    
    .drop-zone.active {
      background-color: rgba(58, 134, 255, 0.1);
      outline: 2px dashed var(--primary);
    }

    button {
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.95rem;
      position: relative;
      overflow: hidden;
    }

    button::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.1);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    button:hover::after {
      opacity: 1;
    }

    body.light button {
      background: #eee;
      color: #222;
      border: 1px solid #ddd;
    }

    body.light button:hover {
      background: #ddd;
      transform: translateY(-1px);
    }

    body.dark button {
      background: #2a2a2a;
      color: #f5f5f5;
      border: 1px solid #444;
    }

    body.dark button:hover {
      background: #3a3a3a;
      transform: translateY(-1px);
    }

    .btn-primary {
      background: var(--primary) !important;
      color: white !important;
      box-shadow: 0 2px 8px rgba(58, 134, 255, 0.3);
    }
    
    .btn-primary:hover {
      box-shadow: 0 4px 12px rgba(58, 134, 255, 0.4);
    }
    
    .btn-secondary {
      background: var(--secondary) !important;
      color: white !important;
    }
    
    .btn-danger {
      background: var(--danger) !important;
      color: white !important;
    }
    
    .btn-success {
      background: var(--success) !important;
      color: white !important;
    }

    .add-game-menu {
      position: absolute;
      top: 100%;
      left: 0;
      background: var(--game-bg);
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 100;
      width: 280px;
      margin-top: 0.5rem;
      display: none;
    }
    
    body.dark .add-game-menu {
      background: #1e1e1e;
    }
    
    .add-game-menu.active {
      display: block;
    }
    
    .add-game-menu input {
      width: calc(100% - 2rem);
      margin-bottom: 0.75rem;
      padding: 0.5rem;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    
    body.dark .add-game-menu input {
      border-color: #444;
    }
    
    .add-game-menu-btn {
      position: relative;
    }

    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(34, 139, 34, 0.9);
      color: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transform: translateX(200%);
      transition: transform 0.3s ease;
      z-index: 3000;
      max-width: 300px;
      backdrop-filter: blur(5px);
      border-left: 4px solid white;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.error {
      background: rgba(255, 68, 68, 0.9);
    }
    
    .notification.warning {
      background: rgba(255, 204, 0, 0.9);
      color: #333;
    }
    
    .cover-dropdown {
      position: relative;
      width: 100%;
      margin-bottom: 0.75rem;
    }
    
    .cover-search-results {
      position: absolute;
      width: 100%;
      max-height: 300px;
      overflow-y: auto;
      background: var(--game-bg);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 100;
      display: none;
    }
    
    .cover-option {
      padding: 0.75rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transition: background-color 0.2s;
    }
    
    .cover-option:hover {
      background: rgba(58, 134, 255, 0.1);
    }
    
    .cover-option img {
      width: 60px;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
    }
    
    .cover-option .game-info {
      flex-grow: 1;
    }
    
    .cover-option .game-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    .cover-option .game-platform {
      font-size: 0.8rem;
      opacity: 0.8;
    }
    
    .loading {
      padding: 1rem;
      text-align: center;
      color: var(--secondary);
    }
    
    .loading-spinner {
      border: 3px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-top: 3px solid var(--primary);
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.05);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
    }

    body.dark ::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
    }

    /* Sync indicator styles */
    .sync-status {
      position: fixed;
      bottom: 10px;
      left: 10px;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 1000;
      background: rgba(0,0,0,0.7);
      color: white;
      backdrop-filter: blur(5px);
    }
    
    .sync-status.syncing {
      background: rgba(58, 134, 255, 0.9);
    }
    
    .sync-status.error {
      background: rgba(255, 68, 68, 0.9);
    }
    
    .sync-status.success {
      background: rgba(34, 139, 34, 0.9);
    }
    
    .sync-spinner {
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top: 2px solid white;
      width: 14px;
      height: 14px;
      animation: spin 1s linear infinite;
    }
    
    #forceSyncBtn {
      margin-left: 0.5rem;
      padding: 0.25rem 0.5rem;
      font-size: 0.7rem;
      background: rgba(255,255,255,0.2);
    }

    @media (max-width: 1200px) {
      .current-grid,
      .game-grid {
        grid-template-columns: repeat(auto-fill, minmax(var(--cover-compact-width), 1fr));
      }
      
      .game {
        width: var(--cover-compact-width);
      }
      
      .banner {
        height: var(--cover-compact-height);
      }
    }

    @media (max-width: 992px) {
      .split-section {
        flex-direction: column;
      }
      
      .backlog-column, 
      .completed-column {
        flex: 100%;
      }
      
      .header-container {
        flex-direction: column;
      }
      
      .header-right {
        align-items: flex-start;
        width: 100%;
      }
      
      .compact-stats {
        width: 100%;
        justify-content: space-between;
      }
    }

    @media (max-width: 768px) {
      .controls-row {
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      
      .search-container {
        flex: 1 1 100%;
        max-width: 100%;
        min-width: 0;
      }
      
      .filter-controls {
        flex: 1 1 auto;
        max-width: 100%;
        justify-content: flex-start;
      }
      
      #sortSelect {
        flex: 0 1 120px;
      }
      
      .current-grid,
      .game-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
      
      .game {
        width: 120px;
      }
      
      .banner {
        height: 160px;
      }
      
      .info {
        padding: 0.5rem;
      }
      
      .game-title {
        font-size: 0.8rem;
      }
    }
    
    @media (max-width: 480px) {
      .controls-row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .search-container,
      #sortSelect {
        width: 100%;
        max-width: 100%;
        flex: 1 1 100%;
      }
      
      .filter-controls {
        flex-direction: column;
        align-items: stretch;
        max-width: 100%;
      }
      
      .theme-toggle {
        align-self: center;
      }
      
      .notification {
        bottom: 10px;
        right: 10px;
        max-width: calc(100% - 20px);
      }
      
      .compact-stats {
        flex-wrap: wrap;
      }
      
      .stat-item {
        min-width: 45px;
      }
      
      .current-grid,
      .game-grid {
        grid-template-columns: 1fr;
      }
      
      .game {
        width: 100%;
        max-width: 180px;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <!-- Auth Modal -->
  <div class="auth-modal" id="authModal">
    <div class="auth-container">
      <div class="auth-header">
        <h2>GameTracker Pro</h2>
        <p>Accedi o registrati per sincronizzare i tuoi giochi</p>
      </div>
      
      <div class="auth-tabs">
        <div class="auth-tab active" id="loginTab">Accedi</div>
        <div class="auth-tab" id="registerTab">Registrati</div>
      </div>
      
      <div class="auth-form active" id="loginForm">
        <div class="auth-form-group">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" placeholder="tua@email.com">
        </div>
        <div class="auth-form-group">
          <label for="loginPassword">Password</label>
          <input type="password" id="loginPassword" placeholder="••••••••">
        </div>
        <button class="auth-submit-btn" id="loginBtn">
          <span id="loginBtnText">Accedi</span>
        </button>
        <div class="auth-error" id="loginError"></div>
      </div>
      
      <div class="auth-form" id="registerForm">
        <div class="auth-form-group">
          <label for="registerEmail">Email</label>
          <input type="email" id="registerEmail" placeholder="tua@email.com">
        </div>
        <div class="auth-form-group">
          <label for="registerPassword">Password</label>
          <input type="password" id="registerPassword" placeholder="••••••••">
        </div>
        <div class="auth-form-group">
          <label for="registerPasswordConfirm">Conferma Password</label>
          <input type="password" id="registerPasswordConfirm" placeholder="••••••••">
        </div>
        <button class="auth-submit-btn" id="registerBtn">
          <span id="registerBtnText">Registrati</span>
        </button>
        <div class="auth-error" id="registerError"></div>
        <div class="auth-success" id="registerSuccess"></div>
      </div>
      
      <div class="auth-footer">
        <a id="forgotPasswordLink">Password dimenticata?</a>
      </div>
    </div>
  </div>

  <!-- Main App Content (hidden until authenticated) -->
  <div id="appContent" style="display: none;">
    <div class="header-container">
      <div class="header-left">
        <h1>GameTracker Pro</h1>
        
        <div class="controls-row">
          <div class="search-container">
            <input type="text" id="gameSearch" placeholder="Cerca giochi..." aria-label="Cerca giochi" />
          </div>
          
          <div class="filter-controls">
            <select id="sortSelect" aria-label="Ordina giochi">
              <option value="name-asc">Nome (A-Z)</option>
              <option value="name-desc">Nome (Z-A)</option>
              <option value="played">Giocati prima</option>
              <option value="platinum">Con platino</option>
            </select>
            
            <button id="toggleThemeBtn" class="theme-toggle" title="Cambia tema" aria-label="Cambia tema">🌙</button>
          </div>
        </div>
      </div>
      
      <div class="header-right">
        <div class="user-profile">
          <div class="user-avatar" id="userAvatar">U</div>
          <div class="user-email" id="userEmail">user@example.com</div>
          <button class="logout-btn" id="logoutBtn">
            <span>Esci</span>
          </button>
        </div>
        
        <div class="compact-stats">
          <div class="stat-item">
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-label">Totale</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="statCurrent">0</div>
            <div class="stat-label">In Corso</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="statBacklog">0</div>
            <div class="stat-label">Backlog</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="statCompleted">0</div>
            <div class="stat-label">Completati</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="statPlatinum">0</div>
            <div class="stat-label">Platini</div>
          </div>
        </div>
        
        <div class="controls-row">
          <div class="add-game-menu-btn">
            <button id="addGameBtn" class="btn-primary">Aggiungi gioco</button>
            <div class="add-game-menu">
              <input type="text" id="newGameName" placeholder="Nome del gioco" required aria-label="Nome del gioco" />
              <div class="cover-dropdown">
                <input type="text" id="coverSearch" placeholder="🔍 Cerca copertina su IGDB..." aria-label="Cerca copertina" />
                <div id="coverResults" class="cover-search-results"></div>
              </div>
              <input type="hidden" id="selectedCoverUrl" />
              <button type="button" id="submitGame" class="btn-primary" style="width: 100%;">Salva</button>
            </div>
          </div>
          
          <button id="resetBtn" class="btn-danger">Reset tracker</button>
          <button id="exportBtn" class="btn-success">Esporta dati</button>
          <input type="file" id="importFile" accept=".json" title="Importa dati JSON" style="display: none;" />
          <button id="importBtn" class="btn-secondary">Importa dati</button>
        </div>
      </div>
    </div>

    <div class="games-section current-section">
      <div class="section-header">
        <h2 class="section-title">Giochi in Corso</h2>
        <span class="game-count" id="currentCount">0</span>
      </div>
      <div class="current-grid drop-zone" id="currentGrid"></div>
    </div>

    <div class="split-section">
      <div class="games-section backlog-column">
        <div class="section-header">
          <h2 class="section-title">Backlog</h2>
          <span class="game-count" id="backlogCount">0</span>
        </div>
        <div class="game-grid drop-zone" id="backlogGrid"></div>
      </div>
      
      <div class="games-section completed-column">
        <div class="section-header">
          <h2 class="section-title">Completati</h2>
          <span class="game-count" id="completedCount">0</span>
        </div>
        <div class="game-grid drop-zone" id="completedGrid"></div>
      </div>
    </div>

    <div id="contextMenu" class="context-menu">
      <div class="context-menu-item" id="cmRename">✏️ Cambia nome</div>
      <div class="context-menu-item" id="cmChangeImage">🖼️ Cambia immagine</div>
      <div class="context-menu-item" id="cmToggleCurrent">🎮 Segna come in corso</div>
      <div class="context-menu-divider"></div>
      <div class="context-menu-item" id="cmTogglePlatinum">🏆 Toggle platino</div>
      <div class="context-menu-divider"></div>
      <div class="context-menu-item" id="cmQuickMove">🚀 Sposta rapido a...</div>
      <div class="context-menu-divider"></div>
      <div class="context-menu-item" id="cmDelete" style="color: var(--danger);">❌ Elimina gioco</div>
    </div>
    
    <div id="quickMoveMenu" class="context-menu" style="display: none;">
      <div class="context-menu-item move-option" data-target="current">🎮 In Corso</div>
      <div class="context-menu-item move-option" data-target="backlog">📥 Backlog</div>
      <div class="context-menu-item move-option" data-target="completed">✅ Completati</div>
    </div>

    <div id="notification" class="notification">
      <span id="notificationText"></span>
    </div>
    
    <div id="syncStatus" class="sync-status">
      <span id="syncStatusText">Non connesso</span>
      <button id="forceSyncBtn" style="display:none;">Sinc. ora</button>
    </div>
  </div>

  <script>
    // Firebase Configuration - Replace with your actual config
    const firebaseConfig = {
  apiKey: "AIzaSyDm946nISfZs8ugkuYPraNTzFhvgQmnMUk",

  authDomain: "gametrackerdb.firebaseapp.com",

  databaseURL: "https://gametrackerdb-default-rtdb.europe-west1.firebasedatabase.app",

  projectId: "gametrackerdb",

  storageBucket: "gametrackerdb.firebasestorage.app",

  messagingSenderId: "132133020733",

  appId: "1:132133020733:web:acf5dd7301771aaffa3654"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // Constants
    const PLATINUM_ICON_URL = "https://i.psnprofiles.com/guides/18274/470bd2.png";
    const DEFAULT_IMAGE = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMTYwIiB2aWV3Qm94PSIwIDAgMzAwIDE2MCI+PHJlY3Qgd2lkdGg9IjMwMCIgaGVpZ2h0PSIxNjAiIGZpbGw9IiNkZGQiLz48dGV4dCB4PSIxNTAiIHk9IjgwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM2NjYiPkltbWFnaW5lIG5vbiBkaXNwb25pYmlsZTwvdGV4dD48L3N2Zz4=';
    const IGDB_PROXY = "https://rough-wind-0456.amrit-singh99mail-5e3.workers.dev/";
    
    // Storage keys
    const STORAGE_KEY_GAMES = 'custom_games';
    const STORAGE_KEY_PLAYED_PREFIX = 'played_';
    const STORAGE_KEY_IMAGE_PREFIX = 'image_';
    const STORAGE_KEY_PLATINUM_PREFIX = 'platinum_';
    const STORAGE_KEY_CURRENT_PREFIX = 'current_';
    const THEME_KEY = 'user_theme';
    
    // Sync settings
    const SYNC_COOLDOWN = 30000; // 5 seconds between syncs
    const FORCE_SYNC_COOLDOWN = 30000; // 30 seconds between forced syncs
    
    // DOM Elements
    const elements = {
      // Auth elements
      authModal: document.getElementById("authModal"),
      loginTab: document.getElementById("loginTab"),
      registerTab: document.getElementById("registerTab"),
      loginForm: document.getElementById("loginForm"),
      registerForm: document.getElementById("registerForm"),
      loginEmail: document.getElementById("loginEmail"),
      loginPassword: document.getElementById("loginPassword"),
      loginBtn: document.getElementById("loginBtn"),
      loginBtnText: document.getElementById("loginBtnText"),
      loginError: document.getElementById("loginError"),
      registerEmail: document.getElementById("registerEmail"),
      registerPassword: document.getElementById("registerPassword"),
      registerPasswordConfirm: document.getElementById("registerPasswordConfirm"),
      registerBtn: document.getElementById("registerBtn"),
      registerBtnText: document.getElementById("registerBtnText"),
      registerError: document.getElementById("registerError"),
      registerSuccess: document.getElementById("registerSuccess"),
      forgotPasswordLink: document.getElementById("forgotPasswordLink"),
      logoutBtn: document.getElementById("logoutBtn"),
      userAvatar: document.getElementById("userAvatar"),
      userEmail: document.getElementById("userEmail"),
      appContent: document.getElementById("appContent"),
      
      // Game elements
      currentGrid: document.getElementById("currentGrid"),
      backlogGrid: document.getElementById("backlogGrid"),
      completedGrid: document.getElementById("completedGrid"),
      currentCount: document.getElementById("currentCount"),
      backlogCount: document.getElementById("backlogCount"),
      completedCount: document.getElementById("completedCount"),
      statTotal: document.getElementById("statTotal"),
      statCurrent: document.getElementById("statCurrent"),
      statBacklog: document.getElementById("statBacklog"),
      statCompleted: document.getElementById("statCompleted"),
      statPlatinum: document.getElementById("statPlatinum"),
      body: document.body,
      themeToggleBtn: document.getElementById('toggleThemeBtn'),
      contextMenu: document.getElementById('contextMenu'),
      quickMoveMenu: document.getElementById('quickMoveMenu'),
      addGameMenu: document.querySelector('.add-game-menu'),
      addGameBtn: document.getElementById('addGameBtn'),
      submitGameBtn: document.getElementById('submitGame'),
      importBtn: document.getElementById('importBtn'),
      importFile: document.getElementById('importFile'),
      resetBtn: document.getElementById('resetBtn'),
      exportBtn: document.getElementById('exportBtn'),
      gameSearch: document.getElementById('gameSearch'),
      sortSelect: document.getElementById('sortSelect'),
      newGameName: document.getElementById('newGameName'),
      coverSearch: document.getElementById('coverSearch'),
      coverResults: document.getElementById('coverResults'),
      selectedCoverUrl: document.getElementById('selectedCoverUrl'),
      notification: document.getElementById('notification'),
      notificationText: document.getElementById('notificationText'),
      syncStatus: document.getElementById('syncStatus'),
      syncStatusText: document.getElementById('syncStatusText'),
      forceSyncBtn: document.getElementById('forceSyncBtn')
    };
    
    // State
    let currentContextGame = null;
    let draggedGame = null;
    let currentUser = null;
    let isSyncing = false;
    let lastSyncTime = 0;
    let lastForceSyncTime = 0;
    let hasChangesToSync = false;
    let syncTimeout = null;

    // Utility Functions
    function sanitizeKey(str) {
      return str.toLowerCase().replace(/[^a-z0-9]/gi, '-');
    }

    function isValidImageUrl(url) {
      if (!url) return false;
      try {
        new URL(url);
        return /\.(jpe?g|png|gif|webp|bmp|svg)(\?.*)?$/i.test(url) || 
               /^(https?:\/\/).*\.(jpg|png|gif|webp|bmp|svg)/i.test(url);
      } catch {
        return false;
      }
    }
    
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function showNotification(message, duration = 3000, type = 'success') {
      const notification = elements.notification;
      const notificationText = elements.notificationText;
      
      notificationText.textContent = message;
      notification.className = `notification ${type}`;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, duration);
    }

    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    function updateSyncStatus(status, message) {
      elements.syncStatus.className = 'sync-status';
      elements.syncStatusText.textContent = message;
      
      switch(status) {
        case 'syncing':
          elements.syncStatus.classList.add('syncing');
          elements.syncStatusText.innerHTML = `<div class="sync-spinner"></div> ${message}`;
          elements.forceSyncBtn.style.display = 'none';
          break;
        case 'success':
          elements.syncStatus.classList.add('success');
          elements.forceSyncBtn.style.display = 'inline-block';
          break;
        case 'error':
          elements.syncStatus.classList.add('error');
          elements.forceSyncBtn.style.display = 'inline-block';
          break;
        case 'offline':
          elements.syncStatus.className = 'sync-status';
          elements.forceSyncBtn.style.display = 'inline-block';
          break;
      }
    }

    // Firebase Functions
    function showAuthModal() {
      elements.authModal.classList.add('active');
    }

    function hideAuthModal() {
      elements.authModal.classList.remove('active');
    }

    function switchToLogin() {
      elements.loginTab.classList.add('active');
      elements.registerTab.classList.remove('active');
      elements.loginForm.classList.add('active');
      elements.registerForm.classList.remove('active');
      elements.loginError.textContent = '';
      elements.registerError.textContent = '';
    }

    function switchToRegister() {
      elements.loginTab.classList.remove('active');
      elements.registerTab.classList.add('active');
      elements.loginForm.classList.remove('active');
      elements.registerForm.classList.add('active');
      elements.loginError.textContent = '';
      elements.registerError.textContent = '';
    }

    function updateUserProfile(user) {
      if (user) {
        currentUser = user;
        elements.userEmail.textContent = user.email;
        elements.userAvatar.textContent = user.email.charAt(0).toUpperCase();
        elements.appContent.style.display = 'block';
        hideAuthModal();
        loadUserData();
        updateSyncStatus('success', 'Connesso');
      } else {
        currentUser = null;
        elements.appContent.style.display = 'none';
        showAuthModal();
        updateSyncStatus('offline', 'Non connesso');
      }
    }

    function loadUserData() {
      if (!currentUser) return;
      
      const userRef = database.ref(`users/${currentUser.uid}`);
      
      userRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        
        // Load games
        if (data.games) {
          localStorage.setItem(STORAGE_KEY_GAMES, JSON.stringify(data.games));
        }
        
        // Load game states
        if (data.gameStates) {
          Object.entries(data.gameStates).forEach(([key, value]) => {
            localStorage.setItem(key, value);
          });
        }
        
        // Load theme preference
        if (data.theme) {
          localStorage.setItem(THEME_KEY, data.theme);
          applyTheme(data.theme);
        }
        
        renderGames();
      });
    }

    function queueSync() {
      hasChangesToSync = true;
      
      // If we're not already waiting to sync, set up a new sync
      if (!syncTimeout) {
        const timeSinceLastSync = Date.now() - lastSyncTime;
        const delay = Math.max(0, SYNC_COOLDOWN - timeSinceLastSync);
        
        syncTimeout = setTimeout(() => {
          if (hasChangesToSync) {
            syncUserData();
          }
          syncTimeout = null;
        }, delay);
      }
    }

    function forceSync() {
      const now = Date.now();
      if (now - lastForceSyncTime < FORCE_SYNC_COOLDOWN) {
        showNotification(`Aspetta ${Math.ceil((FORCE_SYNC_COOLDOWN - (now - lastForceSyncTime)) / 1000)} secondi prima di forzare di nuovo la sincronizzazione`, 3000, 'warning');
        return;
      }
      
      lastForceSyncTime = now;
      syncUserData(true);
    }

    function syncUserData(force = false) {
      if (!currentUser || isSyncing) {
        if (!force) {
          hasChangesToSync = true;
        }
        return;
      }
      
      isSyncing = true;
      lastSyncTime = Date.now();
      hasChangesToSync = false;
      
      updateSyncStatus('syncing', 'Sincronizzazione in corso...');
      
      try {
        // Get all games
        const games = loadCustomGames();
        
        // Get all game states
        const gameStates = {};
        games.forEach(game => {
          const key = sanitizeKey(game.title);
          [STORAGE_KEY_PLAYED_PREFIX, STORAGE_KEY_IMAGE_PREFIX, 
           STORAGE_KEY_PLATINUM_PREFIX, STORAGE_KEY_CURRENT_PREFIX].forEach(prefix => {
            const value = localStorage.getItem(prefix + key);
            if (value !== null) {
              gameStates[prefix + key] = value;
            }
          });
        });
        
        // Get theme
        const theme = localStorage.getItem(THEME_KEY) || 'dark';
        
        // Prepare data to save
        const userData = {
          games,
          gameStates,
          theme
        };
        
        // Only update lastSync if there are actual changes
        if (force || Object.keys(gameStates).length > 0 || games.length > 0) {
          userData.lastSync = firebase.database.ServerValue.TIMESTAMP;
        }
        
        // Save to Firebase
        database.ref(`users/${currentUser.uid}`).set(userData)
          .then(() => {
            updateSyncStatus('success', `Sincronizzato ${new Date().toLocaleTimeString()}`);
            showNotification('Dati sincronizzati con successo', 2000, 'success');
          })
          .catch(error => {
            console.error('Sync failed:', error);
            updateSyncStatus('error', 'Errore di sincronizzazione');
            showNotification('Errore durante la sincronizzazione', 4000, 'error');
            hasChangesToSync = true;
          })
          .finally(() => {
            isSyncing = false;
            
            // If changes happened while we were syncing, queue another sync
            if (hasChangesToSync) {
              queueSync();
            }
          });
      } catch (error) {
        console.error('Sync error:', error);
        updateSyncStatus('error', 'Errore di sincronizzazione');
        isSyncing = false;
        hasChangesToSync = true;
      }
    }

    // Data Functions
    function loadCustomGames() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY_GAMES);
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.error("Error loading games:", e);
        showNotification("Errore nel caricamento dei giochi", 4000, 'error');
        return [];
      }
    }

    function saveCustomGames(customGames) {
      try {
        localStorage.setItem(STORAGE_KEY_GAMES, JSON.stringify(customGames));
        queueSync();
      } catch (e) {
        console.error("Error saving games:", e);
        showNotification("Errore nel salvataggio dei giochi", 4000, 'error');
      }
    }

    function getAllGames() {
      try {
        const games = loadCustomGames();
        const sortBy = elements.sortSelect.value || 'name-asc';
        const searchTerm = elements.gameSearch.value.toLowerCase();
        
        const filteredGames = searchTerm ? 
          games.filter(game => game.title.toLowerCase().includes(searchTerm)) : 
          games;
        
        return filteredGames.sort((a, b) => {
          const aKey = sanitizeKey(a.title);
          const bKey = sanitizeKey(b.title);
          const aPlayed = localStorage.getItem(STORAGE_KEY_PLAYED_PREFIX + aKey) === "true";
          const bPlayed = localStorage.getItem(STORAGE_KEY_PLAYED_PREFIX + bKey) === "true";
          const aPlat = localStorage.getItem(STORAGE_KEY_PLATINUM_PREFIX + aKey) === "true";
          const bPlat = localStorage.getItem(STORAGE_KEY_PLATINUM_PREFIX + bKey) === "true";
          const aCurrent = localStorage.getItem(STORAGE_KEY_CURRENT_PREFIX + aKey) === "true";
          const bCurrent = localStorage.getItem(STORAGE_KEY_CURRENT_PREFIX + bKey) === "true";
          
          if (aCurrent !== bCurrent) return aCurrent ? -1 : 1;
          
          switch(sortBy) {
            case 'name-asc': return a.title.localeCompare(b.title);
            case 'name-desc': return b.title.localeCompare(a.title);
            case 'played': return (aPlayed === bPlayed) ? 0 : aPlayed ? -1 : 1;
            case 'platinum': return (aPlat === bPlat) ? 0 : aPlat ? -1 : 1;
            default: return 0;
          }
        });
      } catch (e) {
        console.error("Error getting games:", e);
        showNotification("Errore nel recupero dei giochi", 4000, 'error');
        return [];
      }
    }

    // IGDB Functions
    async function searchIGDBGames(query) {
      try {
        if (IGDB_PROXY.includes('rough-wind-0456')) {
          console.warn('Using placeholder IGDB proxy URL. Replace with your actual proxy URL.');
        }
        if (!query || query.length < 3) return [];
        
        elements.coverResults.innerHTML = '<div class="loading"><div class="loading-spinner"></div><div>Ricerca in corso...</div></div>';
        
        const response = await fetch(IGDB_PROXY, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            search: query,
            fields: 'name,cover.url,platforms.name'
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!Array.isArray(data)) {
          throw new Error('Invalid response format from IGDB - expected array');
        }
        
        return data.filter(game => game.cover && game.cover.url);

      } catch (error) {
        console.error("IGDB Search Error:", error);
        showNotification("Errore durante la ricerca: " + error.message, 4000, 'error');
        return [];
      }
    }

    function displayCoverResults(games) {
      const resultsContainer = elements.coverResults;
      resultsContainer.innerHTML = '';
      
      if (!Array.isArray(games) || games.length === 0) {
        resultsContainer.innerHTML = `
          <div class="cover-option" style="justify-content:center;">
            Nessun risultato trovato<br>
            <small>Prova un altro nome o verifica la connessione</small>
          </div>
        `;
        resultsContainer.style.display = 'block';
        return;
      }
      
      games.forEach(game => {
        const option = document.createElement('div');
        option.className = 'cover-option';
        
        const platform = game.platforms?.[0]?.name || 'Piattaforma sconosciuta';
        const thumbUrl = game.cover?.url 
          ? `https:${game.cover.url.replace('t_thumb', 't_cover_small_2x')}`
          : DEFAULT_IMAGE;
        
        option.innerHTML = `
          <img src="${thumbUrl}" 
               alt="${escapeHtml(game.name)}" 
               onerror="this.src='${DEFAULT_IMAGE}'">
          <div class="game-info">
            <div class="game-title">${escapeHtml(game.name || 'Sconosciuto')}</div>
            <div class="game-platform">${escapeHtml(platform)}</div>
          </div>
        `;
        
        option.addEventListener('click', () => {
          const fullUrl = game.cover?.url 
            ? `https:${game.cover.url.replace('t_thumb', 't_cover_big')}`
            : DEFAULT_IMAGE;
          
          elements.selectedCoverUrl.value = fullUrl;
          resultsContainer.style.display = 'none';
          showNotification(`Selezionato: ${escapeHtml(game.name)}`);
        });
        
        resultsContainer.appendChild(option);
      });
      
      resultsContainer.style.display = 'block';
    }

    // Game Management Functions
    function updateStats() {
      try {
        const games = getAllGames();
        let totalGames = games.length;
        let currentGames = 0;
        let backlogGames = 0;
        let completedGames = 0;
        let platinumGames = 0;

        games.forEach(game => {
          const key = sanitizeKey(game.title);
          const played = localStorage.getItem(STORAGE_KEY_PLAYED_PREFIX + key) === "true";
          const platinum = localStorage.getItem(STORAGE_KEY_PLATINUM_PREFIX + key) === "true";
          const current = localStorage.getItem(STORAGE_KEY_CURRENT_PREFIX + key) === "true";

          if (current) {
            currentGames++;
          } else if (played) {
            completedGames++;
          } else {
            backlogGames++;
          }

          if (platinum) {
            platinumGames++;
          }
        });

        elements.statTotal.textContent = totalGames;
        elements.statCurrent.textContent = currentGames;
        elements.statBacklog.textContent = backlogGames;
        elements.statCompleted.textContent = completedGames;
        elements.statPlatinum.textContent = platinumGames;
      } catch (e) {
        console.error("Error updating stats:", e);
      }
    }

    function renderGames() {
      try {
        elements.currentGrid.innerHTML = '';
        elements.backlogGrid.innerHTML = '';
        elements.completedGrid.innerHTML = '';
        
        let currentGames = 0;
        let backlogGames = 0;
        let completedGames = 0;

        getAllGames().forEach(game => {
          const keyPlayed = STORAGE_KEY_PLAYED_PREFIX + sanitizeKey(game.title);
          const keyImage = STORAGE_KEY_IMAGE_PREFIX + sanitizeKey(game.title);
          const keyPlat = STORAGE_KEY_PLATINUM_PREFIX + sanitizeKey(game.title);
          const keyCurrent = STORAGE_KEY_CURRENT_PREFIX + sanitizeKey(game.title);

          const played = localStorage.getItem(keyPlayed) === "true";
          const savedImage = localStorage.getItem(keyImage) || game.image;
          const platinum = localStorage.getItem(keyPlat) === "true";
          const current = localStorage.getItem(keyCurrent) === "true";

          const gameEl = document.createElement("div");
          gameEl.className = "game";
          gameEl.dataset.gameTitle = game.title;
          gameEl.setAttribute('aria-label', `Gioco: ${game.title}`);
          gameEl.innerHTML = `
            <div style="position:relative;">
              <img src="${savedImage}" alt="${escapeHtml(game.title)}" class="banner" 
                   title="Doppio click per cambiare immagine" 
                   onerror="this.src='${DEFAULT_IMAGE}'" />
              <button class="copy-btn" aria-label="Copia URL immagine">⎘</button>
              <button class="move-btn" aria-label="Sposta gioco">⇅</button>
              <button class="remove-btn" aria-label="Rimuovi gioco">×</button>
            </div>
            <div class="info">
              <input type="checkbox" ${played ? 'checked' : ''} 
                     title="Segna come giocato" aria-label="Segna come giocato" />
              <div class="game-title" title="${escapeHtml(game.title)}">${escapeHtml(game.title)}</div>
              ${platinum ? `<img src="${PLATINUM_ICON_URL}" alt="Platino" class="platinum-icon" />` : ''}
            </div>
          `;

          if (current) {
            elements.currentGrid.appendChild(gameEl);
            currentGames++;
          } else if (played) {
            elements.completedGrid.appendChild(gameEl);
            completedGames++;
          } else {
            elements.backlogGrid.appendChild(gameEl);
            backlogGames++;
          }

          setupGameEventListeners(gameEl, game);
        });

        elements.currentCount.textContent = currentGames;
        elements.backlogCount.textContent = backlogGames;
        elements.completedCount.textContent = completedGames;
        
        updateStats();
        
        setupDragAndDrop();
      } catch (e) {
        console.error("Error rendering games:", e);
        showNotification("Errore nel rendering dei giochi", 4000, 'error');
      }
    }

    function setupGameEventListeners(gameEl, game) {
      const keyPlayed = STORAGE_KEY_PLAYED_PREFIX + sanitizeKey(game.title);
      const keyImage = STORAGE_KEY_IMAGE_PREFIX + sanitizeKey(game.title);
      const keyPlat = STORAGE_KEY_PLATINUM_PREFIX + sanitizeKey(game.title);
      const keyCurrent = STORAGE_KEY_CURRENT_PREFIX + sanitizeKey(game.title);

      const checkbox = gameEl.querySelector('input[type="checkbox"]');
      checkbox.addEventListener('change', () => {
        localStorage.setItem(keyPlayed, checkbox.checked.toString());
        if (checkbox.checked) {
          localStorage.removeItem(keyCurrent);
        }
        queueSync();
        showNotification(checkbox.checked ? 
          `"${game.title}" segnato come completato!` : 
          `"${game.title}" spostato al backlog`);
        renderGames();
      });

      const imgEl = gameEl.querySelector("img.banner");
      imgEl.addEventListener("dblclick", e => {
        e.preventDefault();
        const currentImage = localStorage.getItem(keyImage) || game.image;
        const newUrl = prompt(`Inserisci il nuovo URL dell'immagine per "${game.title}":`, currentImage);
        if (newUrl && isValidImageUrl(newUrl)) {
          localStorage.setItem(keyImage, newUrl);
          queueSync();
          showNotification(`Immagine per "${game.title}" aggiornata`);
          renderGames();
        } else if (newUrl) {
          showNotification('URL immagine non valido. Supportati: JPG, PNG, GIF, WEBP, BMP, SVG', 4000, 'warning');
        }
      });

      const titleEl = gameEl.querySelector(".game-title");
      titleEl.addEventListener("dblclick", () => {
        const current = localStorage.getItem(keyPlat) === "true";
        localStorage.setItem(keyPlat, (!current).toString());
        queueSync();
        showNotification(current ? 
          `Platino rimosso da "${game.title}"` : 
          `Platino aggiunto a "${game.title}"!`);
        renderGames();
      });

      gameEl.querySelector('.remove-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        if(confirm(`Rimuovere "${game.title}" dalla lista?`)) {
          deleteGame(game.title);
          showNotification(`"${game.title}" rimosso dalla lista`);
        }
      });

      gameEl.querySelector('.copy-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        const savedImage = localStorage.getItem(keyImage) || game.image;
        navigator.clipboard.writeText(savedImage)
          .then(() => showNotification(`URL immagine copiato negli appunti!`))
          .catch(() => {
            const copyText = prompt("Copia questo URL:", savedImage);
            if (copyText !== null) showNotification(`URL immagine copiato!`);
          });
      });
      
      gameEl.querySelector('.move-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        showQuickMoveMenu(game, e.target);
      });

      gameEl.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        showContextMenu(game, e.clientX, e.clientY);
      });
    }

    function showContextMenu(game, x, y) {
      currentContextGame = game;
      elements.contextMenu.style.display = 'block';
      
      const menuWidth = elements.contextMenu.offsetWidth;
      const menuHeight = elements.contextMenu.offsetHeight;
      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;
      
      const adjustedX = Math.min(x, windowWidth - menuWidth - 10);
      const adjustedY = Math.min(y, windowHeight - menuHeight - 10);
      
      elements.contextMenu.style.left = `${adjustedX}px`;
      elements.contextMenu.style.top = `${adjustedY}px`;
      
      const key = sanitizeKey(game.title);
      document.getElementById('cmToggleCurrent').textContent = 
        localStorage.getItem(STORAGE_KEY_CURRENT_PREFIX + key) === "true" ? 
        "⏸️ Rimuovi da 'in corso'" : "🎮 Aggiungi a 'in corso'";
      
      document.getElementById('cmTogglePlatinum').textContent = 
        localStorage.getItem(STORAGE_KEY_PLATINUM_PREFIX + key) === "true" ? 
        "🏅 Rimuovi platino" : "🏆 Aggiungi platino";
    }
    
    function showQuickMoveMenu(game, target) {
      currentContextGame = game;
      const rect = target.getBoundingClientRect();
      
      elements.quickMoveMenu.style.display = 'block';
      elements.quickMoveMenu.style.left = `${rect.left}px`;
      elements.quickMoveMenu.style.top = `${rect.bottom + 5}px`;
    }

    function updateGameName(oldName, newName) {
      if (!newName || newName.trim() === '') return;
      
      newName = newName.trim();
      const customGames = loadCustomGames();
      const gameIndex = customGames.findIndex(g => g.title === oldName);
      
      if (gameIndex === -1) return;
      
      const oldKey = sanitizeKey(oldName);
      const newKey = sanitizeKey(newName);
      
      [STORAGE_KEY_PLAYED_PREFIX, STORAGE_KEY_IMAGE_PREFIX, 
       STORAGE_KEY_PLATINUM_PREFIX, STORAGE_KEY_CURRENT_PREFIX].forEach(prefix => {
        const value = localStorage.getItem(prefix + oldKey);
        if (value !== null) {
          localStorage.setItem(prefix + newKey, value);
          localStorage.removeItem(prefix + oldKey);
        }
      });
      
      customGames[gameIndex].title = newName;
      saveCustomGames(customGames);
      showNotification(`Nome cambiato da "${oldName}" a "${newName}"`);
      renderGames();
    }

    function deleteGame(title) {
      const customGames = loadCustomGames().filter(g => g.title !== title);
      saveCustomGames(customGames);
      
      const key = sanitizeKey(title);
      [STORAGE_KEY_PLAYED_PREFIX, STORAGE_KEY_IMAGE_PREFIX, 
       STORAGE_KEY_PLATINUM_PREFIX, STORAGE_KEY_CURRENT_PREFIX].forEach(prefix => {
        localStorage.removeItem(prefix + key);
      });
      
      queueSync();
      renderGames();
    }

    function moveGameToSection(gameTitle, section) {
      const key = sanitizeKey(gameTitle);
      
      if (section === 'current') {
        localStorage.setItem(STORAGE_KEY_CURRENT_PREFIX + key, "true");
        localStorage.setItem(STORAGE_KEY_PLAYED_PREFIX + key, "false");
        queueSync();
        showNotification(`"${gameTitle}" spostato ai giochi in corso`);
      } 
      else if (section === 'completed') {
        localStorage.setItem(STORAGE_KEY_PLAYED_PREFIX + key, "true");
        localStorage.removeItem(STORAGE_KEY_CURRENT_PREFIX + key);
        queueSync();
        showNotification(`"${gameTitle}" spostato ai giochi completati`);
      } 
      else {
        localStorage.setItem(STORAGE_KEY_PLAYED_PREFIX + key, "false");
        localStorage.removeItem(STORAGE_KEY_CURRENT_PREFIX + key);
        queueSync();
        showNotification(`"${gameTitle}" spostato al backlog`);
      }
      
      renderGames();
    }

    function setupDragAndDrop() {
      let draggedGame = null;

      document.querySelectorAll('.game').forEach(game => {
        game.setAttribute('draggable', 'true');
        
        game.addEventListener('dragstart', (e) => {
          draggedGame = game;
          game.classList.add('dragging');
          e.dataTransfer.setData('text/plain', game.dataset.gameTitle);
          e.dataTransfer.effectAllowed = 'move';
        });
        
        game.addEventListener('dragend', () => {
          game.classList.remove('dragging');
          document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('active'));
        });
      });
      
      document.querySelectorAll('.drop-zone').forEach(zone => {
        zone.addEventListener('dragover', (e) => {
          e.preventDefault();
          if (draggedGame) {
            e.dataTransfer.dropEffect = 'move';
            zone.classList.add('active');
          }
        });
        
        zone.addEventListener('dragleave', () => {
          zone.classList.remove('active');
        });
        
        zone.addEventListener('drop', (e) => {
          e.preventDefault();
          zone.classList.remove('active');
          
          if (!draggedGame) return;
          
          const gameTitle = e.dataTransfer.getData('text/plain');
          const targetSection = zone.closest('.current-section, .backlog-column, .completed-column');
          
          if (!targetSection || !gameTitle) return;
          
          if (targetSection.classList.contains('current-section')) {
            moveGameToSection(gameTitle, 'current');
          } else if (targetSection.classList.contains('completed-column')) {
            moveGameToSection(gameTitle, 'completed');
          } else {
            moveGameToSection(gameTitle, 'backlog');
          }
          
          draggedGame = null;
        });
      });
    }

    function applyTheme(theme) {
      elements.body.classList.remove('light', 'dark');
      if (theme === 'light') {
        elements.body.classList.add('light');
        elements.themeToggleBtn.textContent = '🌙';
        elements.themeToggleBtn.title = 'Passa a tema scuro';
      } else {
        elements.body.classList.add('dark');
        elements.themeToggleBtn.textContent = '☀️';
        elements.themeToggleBtn.title = 'Passa a tema chiaro';
      }
      localStorage.setItem(THEME_KEY, theme);
      queueSync();
    }

    // Initialize the application
    function init() {
      // Set up Firebase auth state listener
      auth.onAuthStateChanged(user => {
        updateUserProfile(user);
      });

      // Set up event listeners
      setupEventListeners();

      // Apply theme
      const savedTheme = localStorage.getItem(THEME_KEY) || 'dark';
      applyTheme(savedTheme);
    }

    function setupEventListeners() {
      // Auth event listeners
      elements.loginTab.addEventListener('click', switchToLogin);
      elements.registerTab.addEventListener('click', switchToRegister);
      
      elements.loginBtn.addEventListener('click', () => {
        const email = elements.loginEmail.value;
        const password = elements.loginPassword.value;
        
        if (!email || !password) {
          elements.loginError.textContent = 'Inserisci email e password';
          return;
        }
        
        elements.loginBtn.disabled = true;
        elements.loginBtnText.innerHTML = '<span class="auth-loading"></span> Accesso in corso...';
        
        auth.signInWithEmailAndPassword(email, password)
          .then(() => {
            // Success handled by auth state listener
          })
          .catch(error => {
            elements.loginError.textContent = getAuthErrorMessage(error);
            elements.loginBtn.disabled = false;
            elements.loginBtnText.textContent = 'Accedi';
          });
      });
      
      elements.registerBtn.addEventListener('click', () => {
        const email = elements.registerEmail.value;
        const password = elements.registerPassword.value;
        const passwordConfirm = elements.registerPasswordConfirm.value;
        
        if (!email || !password || !passwordConfirm) {
          elements.registerError.textContent = 'Compila tutti i campi';
          return;
        }
        
        if (password !== passwordConfirm) {
          elements.registerError.textContent = 'Le password non coincidono';
          return;
        }
        
        if (password.length < 6) {
          elements.registerError.textContent = 'La password deve avere almeno 6 caratteri';
          return;
        }
        
        elements.registerBtn.disabled = true;
        elements.registerBtnText.innerHTML = '<span class="auth-loading"></span> Registrazione in corso...';
        
        auth.createUserWithEmailAndPassword(email, password)
          .then(() => {
            elements.registerError.textContent = '';
            elements.registerSuccess.textContent = 'Registrazione completata!';
            elements.registerBtn.disabled = false;
            elements.registerBtnText.textContent = 'Registrati';
          })
          .catch(error => {
            elements.registerError.textContent = getAuthErrorMessage(error);
            elements.registerBtn.disabled = false;
            elements.registerBtnText.textContent = 'Registrati';
          });
      });
      
      elements.forgotPasswordLink.addEventListener('click', () => {
        const email = elements.loginEmail.value || prompt('Inserisci la tua email per reimpostare la password:');
        if (!email) return;
        
        auth.sendPasswordResetEmail(email)
          .then(() => {
            showNotification('Email di recupero inviata. Controlla la tua casella di posta.', 5000);
          })
          .catch(error => {
            showNotification(getAuthErrorMessage(error), 4000, 'error');
          });
      });
      
      elements.logoutBtn.addEventListener('click', () => {
        auth.signOut()
          .then(() => {
            showNotification('Disconnessione effettuata');
          })
          .catch(error => {
            showNotification('Errore durante la disconnessione', 4000, 'error');
          });
      });
      
      // Game event listeners
      elements.themeToggleBtn.addEventListener('click', () => {
        const currentTheme = elements.body.classList.contains('light') ? 'light' : 'dark';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        applyTheme(newTheme);
        showNotification(`Tema ${newTheme === 'dark' ? 'scuro' : 'chiaro'} attivato`);
      });

      elements.sortSelect.addEventListener('change', renderGames);
      elements.gameSearch.addEventListener('input', renderGames);

      elements.coverSearch.addEventListener('input', debounce(async (e) => {
        const query = e.target.value.trim();
        if (query.length < 3) {
          elements.coverResults.style.display = 'none';
          return;
        }
        
        elements.coverResults.innerHTML = '<div class="loading"><div class="loading-spinner"></div><div>Ricerca in corso...</div></div>';
        elements.coverResults.style.display = 'block';
        
        const games = await searchIGDBGames(query);
        displayCoverResults(games);
      }, 500));

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.cover-dropdown')) {
          elements.coverResults.style.display = 'none';
        }
      });

      elements.resetBtn.addEventListener('click', () => {
        if(confirm("Sei sicuro di voler resettare il tracker? Tutti i dati verranno persi.")) {
          getAllGames().forEach(game => {
            [STORAGE_KEY_PLAYED_PREFIX, STORAGE_KEY_IMAGE_PREFIX, 
             STORAGE_KEY_PLATINUM_PREFIX, STORAGE_KEY_CURRENT_PREFIX].forEach(prefix => {
              localStorage.removeItem(prefix + sanitizeKey(game.title));
            });
          });
          localStorage.removeItem(STORAGE_KEY_GAMES);
          queueSync();
          showNotification('Tracker resettato con successo');
          renderGames();
        }
      });

      elements.exportBtn.addEventListener('click', () => {
        const data = {};
        const customGames = loadCustomGames();
        
        data[STORAGE_KEY_GAMES] = JSON.stringify(customGames);
        
        customGames.forEach(game => {
          const key = sanitizeKey(game.title);
          [STORAGE_KEY_PLAYED_PREFIX, STORAGE_KEY_IMAGE_PREFIX, 
           STORAGE_KEY_PLATINUM_PREFIX, STORAGE_KEY_CURRENT_PREFIX].forEach(prefix => {
            const value = localStorage.getItem(prefix + key);
            if (value !== null) {
              data[prefix + key] = value;
            }
          });
        });

        try {
          const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `game_tracker_data_${new Date().toISOString().split('T')[0]}.json`;
          a.click();
          URL.revokeObjectURL(url);
          showNotification('Dati esportati con successo!');
        } catch (err) {
          showNotification('Errore durante l\'esportazione: ' + err.message, 4000, 'error');
        }
      });

      elements.importBtn.addEventListener('click', () => {
        elements.importFile.click();
      });

      elements.importFile.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (file.size > 2 * 1024 * 1024) {
          showNotification('File troppo grande (max 2MB)', 4000, 'error');
          e.target.value = '';
          return;
        }

        const reader = new FileReader();
        reader.onload = event => {
          try {
            const data = JSON.parse(event.target.result);
            
            if (!data[STORAGE_KEY_GAMES]) {
              throw new Error("Formato file non valido");
            }
            
            if (!confirm("Importare questi dati? I dati esistenti verranno sovrascritti.")) {
              return;
            }
            
            const existingGames = loadCustomGames();
            existingGames.forEach(game => {
              const key = sanitizeKey(game.title);
              [STORAGE_KEY_PLAYED_PREFIX, STORAGE_KEY_IMAGE_PREFIX, 
               STORAGE_KEY_PLATINUM_PREFIX, STORAGE_KEY_CURRENT_PREFIX].forEach(prefix => {
                localStorage.removeItem(prefix + key);
              });
            });
            
            Object.entries(data).forEach(([key, value]) => {
              localStorage.setItem(key, value);
            });
            
            queueSync();
            renderGames();
            
            const importedGames = JSON.parse(data[STORAGE_KEY_GAMES]);
            showNotification(`Importati ${importedGames.length} giochi con successo!`);
          } catch (err) {
            showNotification(`Errore durante l'importazione: ${err.message}`, 4000, 'error');
            console.error(err);
          }
          e.target.value = '';
        };
        
        reader.onerror = () => {
          showNotification('Errore nella lettura del file', 4000, 'error');
          e.target.value = '';
        };
        
        reader.readAsText(file);
      });

      elements.addGameBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        elements.addGameMenu.classList.toggle('active');
      });
      
      elements.submitGameBtn.addEventListener('click', () => {
        const title = elements.newGameName.value.trim();
        const coverUrl = elements.selectedCoverUrl.value || DEFAULT_IMAGE;

        if (!title) {
          showNotification('Inserisci il nome del gioco', 3000, 'warning');
          return;
        }

        const customGames = loadCustomGames();
        if (customGames.some(g => g.title.toLowerCase() === title.toLowerCase())) {
          showNotification('Il gioco è già presente nella lista.', 3000, 'warning');
          return;
        }

        customGames.push({
          title, 
          image: coverUrl
        });
        saveCustomGames(customGames);
        localStorage.setItem(STORAGE_KEY_CURRENT_PREFIX + sanitizeKey(title), "true");
        localStorage.setItem(STORAGE_KEY_IMAGE_PREFIX + sanitizeKey(title), coverUrl);

        elements.newGameName.value = '';
        elements.coverSearch.value = '';
        elements.selectedCoverUrl.value = '';
        elements.coverResults.innerHTML = '';
        elements.addGameMenu.classList.remove('active');

        showNotification(`"${title}" aggiunto ai giochi in corso!`);
        renderGames();
      });

      document.addEventListener('click', (e) => {
        if (!elements.contextMenu.contains(e.target) && 
            !e.target.closest('.context-menu-item') && 
            !e.target.closest('.game')) {
          elements.contextMenu.style.display = 'none';
        }
        
        if (!elements.quickMoveMenu.contains(e.target) && 
            !e.target.classList.contains('move-btn')) {
          elements.quickMoveMenu.style.display = 'none';
        }
        
        if (!elements.addGameMenu.contains(e.target) && 
            e.target !== elements.addGameBtn) {
          elements.addGameMenu.classList.remove('active');
        }
      });
      
      document.addEventListener('contextmenu', (e) => {
        if (!e.target.closest('.game') && elements.contextMenu.style.display === 'block') {
          elements.contextMenu.style.display = 'none';
        }
      });
      
      document.getElementById('cmRename').addEventListener('click', () => {
        if (!currentContextGame) return;
        const newName = prompt("Inserisci il nuovo nome:", currentContextGame.title);
        if (newName && newName.trim() !== '') {
          updateGameName(currentContextGame.title, newName.trim());
        }
        elements.contextMenu.style.display = 'none';
      });
      
      document.getElementById('cmChangeImage').addEventListener('click', () => {
        if (!currentContextGame) return;
        const key = STORAGE_KEY_IMAGE_PREFIX + sanitizeKey(currentContextGame.title);
        const currentImage = localStorage.getItem(key) || currentContextGame.image;
        const newUrl = prompt("Inserisci il nuovo URL immagine:", currentImage);
        if (newUrl && isValidImageUrl(newUrl)) {
          localStorage.setItem(key, newUrl);
          queueSync();
          showNotification(`Immagine per "${currentContextGame.title}" aggiornata`);
          renderGames();
        } else if (newUrl) {
          showNotification('URL immagine non valido!', 3000, 'warning');
        }
        elements.contextMenu.style.display = 'none';
      });
      
      document.getElementById('cmTogglePlatinum').addEventListener('click', () => {
        if (!currentContextGame) return;
        const key = STORAGE_KEY_PLATINUM_PREFIX + sanitizeKey(currentContextGame.title);
        const newValue = localStorage.getItem(key) !== "true";
        localStorage.setItem(key, newValue.toString());
        queueSync();
        showNotification(newValue ? 
          `Platino aggiunto a "${currentContextGame.title}"!` : 
          `Platino rimosso da "${currentContextGame.title}"`);
        renderGames();
        elements.contextMenu.style.display = 'none';
      });
      
      document.getElementById('cmToggleCurrent').addEventListener('click', () => {
        if (!currentContextGame) return;
        const key = STORAGE_KEY_CURRENT_PREFIX + sanitizeKey(currentContextGame.title);
        const newValue = localStorage.getItem(key) !== "true";
        localStorage.setItem(key, newValue.toString());
        if (newValue) {
          localStorage.setItem(STORAGE_KEY_PLAYED_PREFIX + sanitizeKey(currentContextGame.title), "false");
        }
        queueSync();
        showNotification(newValue ? 
          `"${currentContextGame.title}" aggiunto ai giochi in corso!` : 
          `"${currentContextGame.title}" rimosso dai giochi in corso`);
        renderGames();
        elements.contextMenu.style.display = 'none';
      });
      
      document.getElementById('cmQuickMove').addEventListener('click', (e) => {
        e.stopPropagation();
        const rect = elements.contextMenu.getBoundingClientRect();
        elements.quickMoveMenu.style.display = 'block';
        elements.quickMoveMenu.style.left = `${rect.left + rect.width}px`;
        elements.quickMoveMenu.style.top = `${rect.top}px`;
      });
      
      document.querySelectorAll('.move-option').forEach(option => {
        option.addEventListener('click', () => {
          if (!currentContextGame) return;
          const target = option.dataset.target;
          moveGameToSection(currentContextGame.title, target);
          elements.contextMenu.style.display = 'none';
          elements.quickMoveMenu.style.display = 'none';
        });
      });
      
      document.getElementById('cmDelete').addEventListener('click', () => {
        if (!currentContextGame) return;
        if (confirm(`Eliminare "${currentContextGame.title}" dalla lista?`)) {
          deleteGame(currentContextGame.title);
          showNotification(`"${currentContextGame.title}" rimosso dalla lista`);
        }
        elements.contextMenu.style.display = 'none';
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          elements.contextMenu.style.display = 'none';
          elements.quickMoveMenu.style.display = 'none';
          elements.addGameMenu.classList.remove('active');
          elements.coverResults.style.display = 'none';
        }
      });
      
      // Force sync button
      elements.forceSyncBtn.addEventListener('click', forceSync);
    }
    
    function getAuthErrorMessage(error) {
      switch(error.code) {
        case 'auth/invalid-email':
          return 'Email non valida';
        case 'auth/user-disabled':
          return 'Account disabilitato';
        case 'auth/user-not-found':
          return 'Account non trovato';
        case 'auth/wrong-password':
          return 'Password errata';
        case 'auth/email-already-in-use':
          return 'Email già in uso';
        case 'auth/operation-not-allowed':
          return 'Operazione non permessa';
        case 'auth/weak-password':
          return 'Password troppo debole (min. 6 caratteri)';
        case 'auth/too-many-requests':
          return 'Troppi tentativi. Riprova più tardi.';
        default:
          return 'Errore durante l\'autenticazione';
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
