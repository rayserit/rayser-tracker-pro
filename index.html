<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GameTracker Pro</title>
  
  <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NDAgNTEyIj48cGF0aCBmaWxsPSIjM0E4NkZGIiBkPSJNNjAzLjkgMTM1LjVjLTYxLTQxLjgtMTMyLjQtNTQuNy0yMDAtNTQuN0gzMzJjLTYwIDAtMTE1LjggMTIuOS0xNzIgNDItMTggOS43LTMxLjYgMjIuMS00MC42IDM2LjJDNTEuMyAyMTEuMyA0OCAyNTkuNyA0OCAyOTZjMCA0MS40IDIyLjEgODIgNjAuMSA5Ny4xYy0xLjggNC45LTIuOSAxMC4yLTIuOSAxNS44YzAgMTcuNyAxNC4zIDMyIDMyIDMySDM2YzAtNDQtMzYtODAtMzYtODBjMC0zNi40IDQuNC04My4yIDQyLjktMTI2LjRDMTEwLjYgNjEuNiAxNzQuMSAzMiAzMzIgMzJIMTQwYy3LjUgMC0xIDAtMS42IDBjNzYuMyAwIDE0Ny44IDE1LjcgMjA3LjIgNTguOEM0MTggMTI3LjkgNDc5LjEgMTI5IDU0NCAxMjljNzAuNyAwIDEzMi4zLTEuNSAxOTIuNSAxNEM3MzYgMTQ2LjUgNzM2IDEzMiA3MzYgMTMyYzAtNTIuOS00My4xLTk2LTk2LTk2aC0xNWMtMzUuMyAwLTY0IDI4LjctNjQgNjRjMCAyNy4zIDE3LjMgNTEgNDEuNSA2MC4xek01NDQgMzUyYzIxLjIgMCA0MS03LjcgNTYtMjAuNWMxMy42LTEyIDIzLjItMjguMSAyMy4yLTQ1LjVDNjIzLjIgMjQ2IDI3My40IDY0IDMyMCA2NGgtNjRjLTQ0LjIgMC04MCAzNS44LTgwIDgwYzAgMzUuMyAyOC43IDY0IDY0IDY0SDRjLTguOCAwLTE2IDcuMi0xNiAxNnY0YzAgNDQuMiAzNS44IDgwIDgwIDgwaDE0NGMxNy43IDAgMzItMTQuMyAzMi0zMmMwLTE3LjctMTQuMy0zMi0zMi0zMmgtNHYtNjRoMTZ2NjRoMzJ2LTY0aDE2djY0aDMyVjI4OGgxNnY2NGgzMlYyODhoMzJjMTMuMyAwIDI1LjIgNS4zIDM0IDIxLjRjMy42IDYuNiA1LjQgMTQuMiA1LjQgMjIuNmMwIDE3LjctOC45IDMzLjEtMjIuNyA0NC40bC0xMS4yIDkuMnptLTI1MC02NGMtOC44IDAtMTYgNy4yLTE2IDE2djE2aC0xNmMtOC44IDAtMTYgNy4yLTE2IDE2djMyYzAgOC44IDcuMiAxNiAxNiAxNmgxNnYxNmMwIDguOCA3LjIgMTYgMTYgMTZjOC44IDAgMTYtNy4yIDE2LTE2di0xNmgxNmM4LjggMCAxNi03LjIgMTYtMTZ2LTMyYzAtOC44LTcuMi0xNi0xNi0xNmgLTE2di0xNmMwLTguOC03LjItMTYtMTYtMTZ6bTMyIDE3NmMtMTMuMyAwLTI0IDguOS0yNCAyMHMxMC43IDI0IDI0IDI0czI0LTEwLjcgMjQtMjRzLTEwLjctMjQtMjQtMjR6bS0xNDQgMGMtMTMuMyAwLTI0IDEwLjctMjQgMjRzMTAuNyAyNCAyNCAyNHMyNC0xMC43IDI0LTI0cy0xMC43LTI0LTI0LTI0eiIvPjwvc3ZnPg==" type="image/svg+xml">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  
  <style>
    *, *:before, *:after { box-sizing: border-box; }
    :root { --primary: #3A86FF; --secondary: #00B4D8; --danger: #ff4444; --success: #228b22; --warning: #ffcc00; --backlog-bg: #F5F5F5; --completed-bg: #e9ecef; --current-highlight: rgba(58, 134, 255, 0.1); --card-radius: 8px; --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); --cover-width: 180px; --cover-height: 240px; --cover-compact-width: 150px; --cover-compact-height: 200px; --game-bg: white; --menu-bg: white; --menu-hover: #f0f0f0; --divider-color: #eee; --text-primary: #333; --text-secondary: #666; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; padding: 1rem; background: linear-gradient(135deg, #f5f5f5 0%, #e9ecef 100%); color: var(--text-primary); transition: var(--transition); line-height: 1.6; }
    body.dark { background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); color: #f5f5f5; --backlog-bg: #1a1a1a; --completed-bg: #2d2d2d; --current-highlight: rgba(58, 134, 255, 0.2); --game-bg: #1e1e1e; --menu-bg: #2d2d2d; --menu-hover: #3a3a3a; --divider-color: #444; --text-primary: #f5f5f5; --text-secondary: #aaa; }
    .btn-icon { display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 1.2rem; }
    .btn-icon i { font-size: 1.2rem; }
    .context-menu-item i { width: 20px; text-align: center; margin-right: 10px; font-size: 0.9em; }
    #cmToggleCurrent i { color: var(--primary); }
    #cmTogglePlatinum i { color: #FFD700; }
    #cmDelete i { color: var(--danger); }
    #cmQuickMove i { color: var(--secondary); }
    #cmRename i { color: #666; opacity: 0.8; }
    .context-menu-item:hover i { transform: scale(1.1); transition: transform 0.2s; }
    .header-container { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; margin-bottom: 1.5rem; }
    .header-left { flex: 1; min-width: 0; }
    .header-right { display: flex; flex-direction: column; align-items: flex-end; }
    .controls-row.top-row { margin-bottom: 0.75rem; }
    .logo-container { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; }
    .logo-container .logo-icon { font-size: 2.5rem; color: var(--primary); line-height: 1; }
    .logo-container h1 { font-size: 2rem; font-weight: 800; margin: 0; color: var(--primary); }
    .action-buttons { display: flex; gap: 0.75rem; flex-wrap: wrap; }
    .controls-row.bottom-row { margin-top: 1.5rem; display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }
    .game-title { white-space: normal; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.3; max-height: 2.6em; font-size: 0.85rem; }
    .auth-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:flex;justify-content:center;align-items:center;z-index:1000;opacity:0;visibility:hidden;transition:all .3s ease}.auth-modal.active{opacity:1;visibility:visible}.auth-container{background:var(--game-bg);border-radius:12px;width:100%;max-width:400px;padding:2rem;box-shadow:0 10px 25px rgba(0,0,0,.2);transform:translateY(20px);transition:transform .3s ease}.auth-modal.active .auth-container{transform:translateY(0)}.auth-header{text-align:center;margin-bottom:1.5rem}.auth-header h2{color:var(--primary);margin-bottom:.5rem}.auth-tabs{display:flex;margin-bottom:1.5rem;border-bottom:1px solid var(--divider-color)}.auth-tab{flex:1;text-align:center;padding:.75rem;cursor:pointer;font-weight:600;color:var(--text-secondary);transition:all .2s ease;border-bottom:2px solid transparent}.auth-tab.active{color:var(--primary);border-bottom-color:var(--primary)}.auth-form{display:none}.auth-form.active{display:block}.auth-form-group{margin-bottom:1rem}.auth-form-group label{display:block;margin-bottom:.5rem;font-weight:500;color:var(--text-primary)}.auth-form-group input{width:100%;padding:.75rem;border-radius:8px;border:1px solid var(--divider-color);background:var(--backlog-bg);color:var(--text-primary);font-size:1rem;transition:all .2s ease}.auth-form-group input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(58,134,255,.2)}.auth-submit-btn{width:100%;padding:.75rem;border-radius:8px;background:var(--primary);color:#fff;font-weight:600;border:none;cursor:pointer;margin-top:1rem;transition:all .2s ease}.auth-submit-btn:hover{background:#2a75e6;transform:translateY(-1px)}.auth-footer{text-align:center;margin-top:1.5rem;color:var(--text-secondary)}.auth-footer a{color:var(--primary);text-decoration:none;font-weight:500;cursor:pointer}.auth-error{color:var(--danger);font-size:.9rem;margin-top:.5rem;text-align:center}.auth-success{color:var(--success);font-size:.9rem;margin-top:.5rem;text-align:center}.auth-loading{display:inline-block;width:20px;height:20px;border:3px solid hsla(0,0%,100%,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite;margin-right:8px;vertical-align:middle}.user-profile{display:flex;align-items:center;gap:.75rem;margin-bottom:1rem}.user-avatar{width:40px;height:40px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;text-transform:uppercase}.user-email{font-size:.9rem;color:var(--text-secondary)}.logout-btn{background:none;border:none;color:var(--danger);cursor:pointer;font-size:.9rem;display:flex;align-items:center;gap:.25rem;padding:.25rem;margin-left:auto}h2,h3{margin-top:0;font-weight:600}.compact-stats{display:flex;gap:.5rem;background:rgba(58,134,255,.08);border-radius:12px;padding:.5rem;border:1px solid rgba(58,134,255,.1);margin-bottom:1rem}.stat-item{padding:.75rem;border-radius:8px;background:rgba(58,134,255,.05);transition:all .2s ease;display:flex;flex-direction:column;align-items:center;min-width:60px}.stat-item:hover{background:rgba(58,134,255,.1)}.stat-value{font-weight:800;color:var(--primary);font-size:1.5rem}.stat-label{font-size:.7rem;opacity:.8;text-align:center}.filter-controls{display:flex;gap:.75rem;align-items:center;max-width:240px}.search-container{position:relative;flex:1 1 200px;min-width:150px;max-width:250px}#gameSearch{width:100%;padding:.7rem 1rem .7rem 2.5rem;border-radius:8px;border:none;font-size:.95rem;transition:var(--transition);background-position:1rem center;background-repeat:no-repeat;background-size:1rem}body.light #gameSearch{background-color:#f5f5f5;color:#333;border:1px solid #e0e0e0;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E")}body.light #gameSearch:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(58,134,255,.2);background-color:#fff}body.dark #gameSearch{background-color:#2a2a2a;color:#f5f5f5;border:1px solid #444;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23aaa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E")}body.dark #gameSearch:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(58,134,255,.3);background-color:#333}#sortSelect{-webkit-appearance:none;-moz-appearance:none;appearance:none;padding:.7rem 2.5rem .7rem 1rem;border-radius:8px;border:none;font-size:.95rem;cursor:pointer;transition:var(--transition);background-position:right 1rem center;background-repeat:no-repeat;background-size:1rem;flex:0 1 150px}body.light #sortSelect{background-color:#f5f5f5;color:#333;border:1px solid #e0e0e0;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E")}body.light #sortSelect:hover{background-color:#eee}body.dark #sortSelect{background-color:#2a2a2a;color:#f5f5f5;border:1px solid #444;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23aaa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E")}body.dark #sortSelect:hover{background-color:#333}#sortSelect:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(58,134,255,.2)}.theme-toggle{width:42px;height:42px;min-width:42px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;padding:0;border-radius:50%;flex:0 0 42px}.theme-toggle:focus{outline:2px solid var(--primary);outline-offset:2px}.games-section{margin-bottom:2rem}.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:.75rem;border-bottom:2px solid var(--primary);position:relative}.section-header::after{content:'';position:absolute;bottom:-2px;left:0;width:100px;height:2px;background:var(--secondary)}.section-title{font-size:1.4rem;color:var(--primary);margin:0;font-weight:700;letter-spacing:.5px}.game-count{background:var(--primary);color:#fff;padding:.35rem .9rem;border-radius:20px;font-size:.8rem;font-weight:600;margin-left:.5rem}.current-section{background:var(--current-highlight);border-radius:var(--card-radius);padding:1.5rem;margin-bottom:2rem}.current-grid,.game-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(var(--cover-width),1fr));gap:1.5rem}.game{background:var(--game-bg);border-radius:12px;overflow:hidden;transition:all .3s ease;position:relative;box-shadow:0 4px 12px rgba(0,0,0,.1);width:var(--cover-width);border:1px solid rgba(0,0,0,.05);animation:fadeIn .3s ease forwards}@keyframes fadeIn{0%{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}body.dark .game{box-shadow:0 4px 12px rgba(0,0,0,.25);border-color:hsla(0,0%,100%,.05)}.current-section .game{border-top:3px solid var(--primary)}.backlog-column .game{border-top:3px dashed #aaa}.completed-column .game{border-top:3px solid #00B4D8}.game:hover{transform:translateY(-3px);box-shadow:0 6px 16px rgba(0,0,0,.15)}.banner{width:100%;height:var(--cover-height);-o-object-fit:cover;object-fit:cover;-o-object-position:center top;object-position:center top;cursor:pointer;transition:transform .3s ease;background:linear-gradient(45deg,#1a1a1a,#333);position:relative;image-rendering:-webkit-optimize-contrast;image-rendering:crisp-edges}.info{padding:.75rem;display:flex;align-items:center;gap:.5rem}
    .game .banner-container { position: relative; }
    .game-actions-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, transparent 50%); opacity: 0; transition: var(--transition); display: flex; justify-content: flex-end; align-items: flex-start; padding: 0.5rem; gap: 0.5rem; }
    .game:hover .game-actions-overlay { opacity: 1; }
    .game-actions-overlay .action-icon { color: white; font-size: 0.9rem; cursor: pointer; width: 30px; height: 30px; border-radius: 50%; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; transition: var(--transition); text-shadow: 0 1px 3px black; }
    .game-actions-overlay .action-icon:hover { transform: scale(1.2); background: var(--primary); }
    .action-icon.remove-btn:hover { background: var(--danger); }
    .action-icon.copy-btn:hover { background: var(--secondary); }
    input[type=checkbox]{-webkit-appearance:none;appearance:none;width:18px;height:18px;min-width:18px;min-height:18px;vertical-align:middle;font-size:16px;border:2px solid var(--primary);border-radius:4px;cursor:pointer;position:relative;transition:all .2s ease;box-sizing:border-box;background:#fff}input[type=checkbox]:checked{background-color:var(--primary)}input[type=checkbox]:checked::after{content:'âœ“';position:absolute;color:#fff;font-size:12px;top:50%;left:50%;transform:translate(-50%,-50%)}body.light input[type=checkbox]:checked+.game-title{color:var(--success)}body.dark input[type=checkbox]:checked+.game-title{color:#4CAF50}.platinum-icon{width:18px;height:18px;filter:drop-shadow(0 0 2px rgba(0,0,0,.3))}.context-menu{position:fixed;background:var(--menu-bg);border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.2);z-index:1000;width:220px;display:none;overflow:hidden;border:1px solid rgba(0,0,0,.1);border:1px solid var(--divider-color);box-shadow:0 4px 12px rgba(0,0,0,.15)}body.dark .context-menu{box-shadow:0 4px 12px rgba(0,0,0,.3);border-color:hsla(0,0%,100%,.1)}.context-menu-item{padding:.75rem 1rem;cursor:pointer;transition:all .15s ease;display:flex;align-items:center;gap:.75rem;font-size:.9rem}.context-menu-item:hover{background:var(--menu-hover)}.context-menu-divider{height:1px;background:var(--divider-color);margin:.25rem 0}.game.dragging{opacity:.5;transform:scale(.95)}.drop-zone{transition:background-color .3s;min-height:100px}.drop-zone.active{background-color:rgba(58,134,255,.1);outline:2px dashed var(--primary)}button{border:none;padding:.6rem 1.2rem;border-radius:8px;font-weight:600;cursor:pointer;transition:var(--transition);display:flex;align-items:center;gap:.5rem;font-size:.95rem;position:relative;overflow:hidden}button::after{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:hsla(0,0%,100%,.1);opacity:0;transition:opacity .2s ease}button:hover::after{opacity:1}body.light button{background:#eee;color:#222;border:1px solid #ddd}body.light button:hover{background:#ddd;transform:translateY(-1px)}body.dark button{background:#2a2a2a;color:#f5f5f5;border:1px solid #444}body.dark button:hover{background:#3a3a3a;transform:translateY(-1px)}.btn-primary{background:var(--primary)!important;color:#fff!important;box-shadow:0 2px 8px rgba(58,134,255,.3)}.btn-primary:hover{box-shadow:0 4px 12px rgba(58,134,255,.4)}.btn-secondary{background:var(--secondary)!important;color:#fff!important}.btn-danger{background:var(--danger)!important;color:#fff!important}.btn-success{background:var(--success)!important;color:#fff!important}.notification{position:fixed;bottom:20px;right:20px;background:var(--success);color:#fff;padding:1rem;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.2);transform:translateX(200%);transition:transform .3s ease;z-index:3000;max-width:300px;border-left:4px solid var(--primary)}.notification.show{transform:translateX(0)}.notification.error{background:var(--danger)}.notification.warning{background:var(--warning);color:#333}.loading{padding:1rem;text-align:center;color:var(--secondary)}.loading-spinner{border:3px solid rgba(0,0,0,.1);border-radius:50%;border-top:3px solid var(--primary);width:20px;height:20px;animation:spin 1s linear infinite;margin:0 auto}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-track{background:rgba(0,0,0,.05)}::-webkit-scrollbar-thumb{background:rgba(0,0,0,.2);border-radius:4px}body.dark ::-webkit-scrollbar-thumb{background:hsla(0,0%,100%,.2)}.sync-status{position:fixed;bottom:10px;left:10px;padding:.5rem 1rem;border-radius:20px;font-size:.8rem;display:flex;align-items:center;gap:.5rem;z-index:1000;background:rgba(0,0,0,.7);color:#fff;backdrop-filter:blur(5px)}.sync-status.syncing{background:rgba(58,134,255,.9)}.sync-status.error{background:rgba(255,68,68,.9)}.sync-status.success{background:rgba(34,139,34,.9)}.sync-spinner{border:2px solid hsla(0,0%,100%,.3);border-radius:50%;border-top:2px solid #fff;width:14px;height:14px;animation:spin 1s linear infinite}#forceSyncBtn{margin-left:.5rem;padding:.25rem .5rem;font-size:.7rem;background:hsla(0,0%,100%,.2)}
    .add-game-search-container { margin-bottom: 1.5rem; }
    #modalGameSearch { width: 100%; padding: 0.9rem 1.2rem; font-size: 1.1rem; border-radius: var(--card-radius); border: 1px solid var(--divider-color); background: var(--backlog-bg); color: var(--text-primary); transition: var(--transition); }
    #modalGameSearch:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.2); }
    .add-game-results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 1rem; min-height: 250px; max-height: 40vh; overflow-y: auto; padding: 0.5rem; background-color: rgba(0,0,0,0.05); border-radius: var(--card-radius); }
    .game-result-card { cursor: pointer; border-radius: var(--card-radius); overflow: hidden; border: 3px solid transparent; transition: all 0.2s ease; position: relative; }
    .game-result-card:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .game-result-card.selected { border-color: var(--primary); transform: scale(1.03); box-shadow: 0 6px 20px rgba(58, 134, 255, 0.4); }
    .game-result-card img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .game-result-card .title { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 100%); color: white; font-size: 0.8rem; padding: 1.5rem 0.5rem 0.5rem; text-align: center; font-weight: 600; }
    .add-game-footer { margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: space-between; align-items: center; }
    .footer-cancel-btn { background: none; border: none; color: var(--text-secondary); font-weight: 600; padding: 0.75rem 0; cursor: pointer; transition: var(--transition); }
    .footer-cancel-btn:hover { color: var(--primary); text-decoration: underline; }
    #modalSubmitGame { min-width: 200px; margin-top: 0; }
    #modalSubmitGame:disabled { background-color: #555 !important; color: #999 !important; cursor: not-allowed; box-shadow: none; transform: none; }
    #modalSubmitGame:disabled::after { opacity: 0; }
    .game-result-card.owned { cursor: not-allowed; opacity: 0.6; }
    .game-result-card.owned:hover { transform: none; box-shadow: none; }
    .game-result-card .owned-badge { position: absolute; top: 8px; right: 8px; background-color: var(--success); color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 700; z-index: 2; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .game-result-card .owned-badge i { margin-right: 4px; }
    .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-secondary); border: 2px dashed var(--divider-color); border-radius: var(--card-radius); margin: 1rem; }
    .empty-state i { font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; }

    @media (max-width: 1200px) { .current-grid, .game-grid { grid-template-columns: repeat(auto-fill, minmax(var(--cover-compact-width),1fr)); } .game { width: var(--cover-compact-width); } .banner { height: var(--cover-compact-height); } }
    @media (max-width: 992px) { .split-section { flex-direction: column; } .backlog-column, .completed-column { width: 100%; } }
    @media (max-width: 768px) { .controls-row.bottom-row { flex-wrap: wrap; gap: .5rem; } .search-container { flex: 1 1 100%; max-width: 100%; min-width: 0; } .filter-controls { flex: 1 1 auto; max-width: 100%; justify-content: flex-start; } #sortSelect { flex: 0 1 120px; } .current-grid, .game-grid { grid-template-columns: repeat(auto-fill,minmax(120px,1fr)); } .game { width: 120px; } .banner { height: 160px; } .info { padding: .5rem; } }
    
    /* OTTIMIZZAZIONE MOBILE */
    @media (max-width: 576px) {
      body { padding: 0.5rem; }
      .logo-container .logo-icon { font-size: 2rem; }
      .logo-container h1 { font-size: 1.5rem; }
      .compact-stats { justify-content: center; gap: 0.25rem; }
      .stat-item { padding: 0.5rem; min-width: 55px; }
      .controls-row.bottom-row { flex-direction: column; align-items: stretch; gap: 0.75rem; }
      .search-container, #sortSelect { width: 100%; max-width: 100%; }
      .theme-toggle { align-self: center; margin-top: 0.5rem; }
      .current-grid, .game-grid { gap: 1rem; }
      .game .info { padding: 0.5rem; gap: 0.25rem; }
      .game .game-title { font-size: 0.75rem; -webkit-line-clamp: 3; max-height: 3.45em; }
      .auth-container { padding: 1.5rem; }
      .add-game-results-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 0.75rem; }
    }
  </style>
</head>
<body>
  <!-- Auth Modal -->
  <div class="auth-modal" id="authModal">
    <div class="auth-container">
      <div class="auth-header">
        <h2>GameTracker Pro</h2>
        <p>Accedi o registrati per sincronizzare i tuoi giochi</p>
      </div>
      <div class="auth-tabs">
        <div class="auth-tab active" id="loginTab">Accedi</div>
        <div class="auth-tab" id="registerTab">Registrati</div>
      </div>
      <div class="auth-form active" id="loginForm">
        <div class="auth-form-group">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" placeholder="tua@email.com">
        </div>
        <div class="auth-form-group">
          <label for="loginPassword">Password</label>
          <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <button class="auth-submit-btn" id="loginBtn"><span id="loginBtnText">Accedi</span></button>
        <div class="auth-error" id="loginError"></div>
      </div>
      <div class="auth-form" id="registerForm">
        <div class="auth-form-group">
          <label for="registerEmail">Email</label>
          <input type="email" id="registerEmail" placeholder="tua@email.com">
        </div>
        <div class="auth-form-group">
          <label for="registerPassword">Password</label>
          <input type="password" id="registerPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <div class="auth-form-group">
          <label for="registerPasswordConfirm">Conferma Password</label>
          <input type="password" id="registerPasswordConfirm" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <button class="auth-submit-btn" id="registerBtn"><span id="registerBtnText">Registrati</span></button>
        <div class="auth-error" id="registerError"></div>
        <div class="auth-success" id="registerSuccess"></div>
      </div>
      <div class="auth-footer"><a id="forgotPasswordLink">Password dimenticata?</a></div>
    </div>
  </div>

  <!-- Modale ottimizzato per aggiungere giochi -->
  <div class="auth-modal" id="addGameModal">
    <div class="auth-container" style="max-width: 800px;">
      <div class="auth-header">
        <h2>Aggiungi un nuovo gioco</h2>
        <p>Cerca nel database di IGDB e seleziona il gioco da aggiungere.</p>
      </div>
      <div class="add-game-search-container">
        <input type="text" id="modalGameSearch" placeholder="ðŸ” Scrivi il nome di un gioco..." autocomplete="off">
      </div>
      <div class="add-game-results-grid" id="modalGameResults">
        <!-- I risultati della ricerca appariranno qui -->
      </div>
      <div class="add-game-footer">
          <button class="footer-cancel-btn" id="closeAddGameModalBtn">Annulla</button>
          <button class="auth-submit-btn btn-icon" id="modalSubmitGame" disabled>
              <i class="fas fa-plus-circle"></i>
              <span>Aggiungi alla Libreria</span>
          </button>
      </div>
    </div>
  </div>

  <!-- Main App Content -->
  <div id="appContent" style="display: none;">
    <div class="header-container">
      <div class="header-left">
        <div class="logo-container">
            <i class="fas fa-gamepad logo-icon"></i>
            <h1>GameTracker</h1>
        </div>
        <div class="controls-row top-row">
          <div class="action-buttons">
            <button id="showAddGameModalBtn" class="btn-primary btn-icon">
              <i class="fas fa-plus-circle"></i>
              <span>Aggiungi gioco</span>
            </button>
            <button id="resetBtn" class="btn-danger btn-icon">
              <i class="fas fa-sync"></i>
              <span>Reset tracker</span>
            </button>
            <button id="exportBtn" class="btn-success btn-icon">
              <i class="fas fa-download"></i>
              <span>Esporta dati</span>
            </button>
            <input type="file" id="importFile" accept=".json" title="Importa dati JSON" style="display: none;" />
            <button id="importBtn" class="btn-secondary btn-icon">
              <i class="fas fa-upload"></i>
              <span>Importa dati</span>
            </button>
          </div>
        </div>
        <div class="controls-row bottom-row">
          <div class="search-container">
            <input type="text" id="gameSearch" placeholder="Cerca giochi..." aria-label="Cerca giochi" />
          </div>
          <div class="filter-controls">
            <select id="sortSelect" aria-label="Ordina giochi">
              <option value="name-asc">Nome (A-Z)</option>
              <option value="name-desc">Nome (Z-A)</option>
              <option value="last-played">Ultimo giocato</option>
              <option value="played">Giocati prima</option>
              <option value="platinum">Con platino</option>
            </select>
            <button id="toggleThemeBtn" class="theme-toggle" title="Cambia tema" aria-label="Cambia tema">ðŸŒ™</button>
          </div>
        </div>
      </div>
      <div class="header-right">
        <div class="user-profile">
          <div class="user-avatar" id="userAvatar">U</div>
          <div class="user-email" id="userEmail">user@example.com</div>
          <button id="shareBtn" title="Condividi la tua libreria" style="background:none; border:none; cursor:pointer; color: var(--secondary); font-size: 1.2rem; margin-left: 1rem;">
              <i class="fas fa-share-alt"></i>
          </button>
          <button class="logout-btn" id="logoutBtn"><span>Esci</span></button>
        </div>
        <div class="compact-stats">
          <div class="stat-item"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Totale</div></div>
          <div class="stat-item"><div class="stat-value" id="statCurrent">0</div><div class="stat-label">In Corso</div></div>
          <div class="stat-item"><div class="stat-value" id="statBacklog">0</div><div class="stat-label">Backlog</div></div>
          <div class="stat-item"><div class="stat-value" id="statCompleted">0</div><div class="stat-label">Completati</div></div>
          <div class="stat-item"><div class="stat-value" id="statPlatinum">0</div><div class="stat-label">Platini</div></div>
        </div>
      </div>
    </div>
    <div class="games-section current-section">
      <div class="section-header">
        <h2 class="section-title">Giochi in Corso</h2>
        <span class="game-count" id="currentCount">0</span>
      </div>
      <div class="current-grid drop-zone" id="currentGrid"></div>
    </div>
    <div class="split-section">
      <div class="games-section backlog-column">
        <div class="section-header"><h2 class="section-title">Backlog</h2><span class="game-count" id="backlogCount">0</span></div>
        <div class="game-grid drop-zone" id="backlogGrid"></div>
      </div>
      <div class="games-section completed-column">
        <div class="section-header"><h2 class="section-title">Completati</h2><span class="game-count" id="completedCount">0</span></div>
        <div class="game-grid drop-zone" id="completedGrid"></div>
      </div>
    </div>
    <div id="contextMenu" class="context-menu">
      <div class="context-menu-item" id="cmRename"><i class="fas fa-edit"></i><span>Cambia nome</span></div>
      <div class="context-menu-item" id="cmChangeImage"><i class="fas fa-image"></i><span>Cambia immagine</span></div>
      <div class="context-menu-item" id="cmToggleCurrent"><i class="fas fa-play-circle"></i><span>Aggiungi a 'in corso'</span></div>
      <div class="context-menu-divider"></div>
      <div class="context-menu-item" id="cmTogglePlatinum"><i class="fas fa-trophy"></i><span>Toggle platino</span></div>
      <div class="context-menu-divider"></div>
      <div class="context-menu-item" id="cmQuickMove"><i class="fas fa-exchange-alt"></i><span>Sposta rapido a...</span></div>
      <div class="context-menu-divider"></div>
      <div class="context-menu-item" id="cmDelete" style="color: var(--danger);"><i class="fas fa-trash-alt"></i><span>Elimina gioco</span></div>
    </div>
    <div id="quickMoveMenu" class="context-menu" style="display: none;">
      <div class="context-menu-item move-option" data-target="current"><i class="fas fa-play-circle"></i><span>In Corso</span></div>
      <div class="context-menu-item move-option" data-target="backlog"><i class="fas fa-list"></i><span>Backlog</span></div>
      <div class="context-menu-item move-option" data-target="completed"><i class="fas fa-check-circle"></i><span>Completati</span></div>
    </div>
    <div id="notification" class="notification"><span id="notificationText"></span></div>
    <div id="syncStatus" class="sync-status"><span id="syncStatusText">Non connesso</span><button id="forceSyncBtn" style="display:none;">Sinc. ora</button></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDm946nISfZs8ugkuYPraNTzFhvgQmnMUk",
      authDomain: "gametrackerdb.firebaseapp.com",
      databaseURL: "https://gametrackerdb-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gametrackerdb",
      storageBucket: "gametrackerdb.firebasestorage.app",
      messagingSenderId: "132133020733",
      appId: "1:132133020733:web:acf5dd7301771aaffa3654"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    const PLATINUM_ICON_URL = "https://i.psnprofiles.com/guides/18274/470bd2.png";
    const DEFAULT_IMAGE = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMTYwIiB2aWV3Qm94PSIwIDAgMzAwIDE2MCI+PHJlY3Qgd2lkdGg9IjMwMCIgaGVpZHRoPSIxNjAiIGZpbGw9IiNkZGQiLz48dGV4dCB4PSIxNTAiIHk9IjgwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIHRleHQtYW5jaGyPSJtaWRkbGUiIGZpbGw9IiM2NjYiPlImbXVzO2ltbWFnaW5lIG5vbiBkaXNwb25pYmlsZTwvdGV4dD48L3N2Zz4=';
    const IGDB_PROXY = "https://rough-wind-0456.amrit-singh99mail-5e3.workers.dev/";
    
    const STORAGE_KEY_GAMES = 'custom_games';
    const THEME_KEY = 'user_theme';
    const FORCE_SYNC_COOLDOWN = 30000;
    
    const elements = {
      authModal:document.getElementById("authModal"),loginTab:document.getElementById("loginTab"),registerTab:document.getElementById("registerTab"),loginForm:document.getElementById("loginForm"),registerForm:document.getElementById("registerForm"),loginEmail:document.getElementById("loginEmail"),loginPassword:document.getElementById("loginPassword"),loginBtn:document.getElementById("loginBtn"),loginBtnText:document.getElementById("loginBtnText"),loginError:document.getElementById("loginError"),registerEmail:document.getElementById("registerEmail"),registerPassword:document.getElementById("registerPassword"),registerPasswordConfirm:document.getElementById("registerPasswordConfirm"),registerBtn:document.getElementById("registerBtn"),registerBtnText:document.getElementById("registerBtnText"),registerError:document.getElementById("registerError"),registerSuccess:document.getElementById("registerSuccess"),forgotPasswordLink:document.getElementById("forgotPasswordLink"),logoutBtn:document.getElementById("logoutBtn"),userAvatar:document.getElementById("userAvatar"),userEmail:document.getElementById("userEmail"),appContent:document.getElementById("appContent"),currentGrid:document.getElementById("currentGrid"),backlogGrid:document.getElementById("backlogGrid"),completedGrid:document.getElementById("completedGrid"),currentCount:document.getElementById("currentCount"),backlogCount:document.getElementById("backlogCount"),completedCount:document.getElementById("completedCount"),statTotal:document.getElementById("statTotal"),statCurrent:document.getElementById("statCurrent"),statBacklog:document.getElementById("statBacklog"),statCompleted:document.getElementById("statCompleted"),statPlatinum:document.getElementById("statPlatinum"),body:document.body,themeToggleBtn:document.getElementById("toggleThemeBtn"),contextMenu:document.getElementById("contextMenu"),quickMoveMenu:document.getElementById("quickMoveMenu"),importBtn:document.getElementById("importBtn"),importFile:document.getElementById("importFile"),resetBtn:document.getElementById("resetBtn"),exportBtn:document.getElementById("exportBtn"),gameSearch:document.getElementById("gameSearch"),sortSelect:document.getElementById("sortSelect"),notification:document.getElementById("notification"),notificationText:document.getElementById("notificationText"),syncStatus:document.getElementById("syncStatus"),syncStatusText:document.getElementById("syncStatusText"),forceSyncBtn:document.getElementById("forceSyncBtn"),
      addGameModal: document.getElementById("addGameModal"),
      showAddGameModalBtn: document.getElementById("showAddGameModalBtn"),
      closeAddGameModalBtn: document.getElementById("closeAddGameModalBtn"),
      modalGameSearch: document.getElementById("modalGameSearch"),
      modalGameResults: document.getElementById("modalGameResults"),
      modalSubmitGame: document.getElementById("modalSubmitGame"),
      shareBtn: document.getElementById('shareBtn')
    };
    
    let currentContextGame = null;
    let draggedGame = null;
    let currentUser = null;
    let isSyncing = false;
    let lastForceSyncTime = 0;
    let hasChangesToSync = false;
    let selectedGameForAddition = null;

    function sanitizeKey(str){return str.toLowerCase().replace(/[^a-z0-9]/gi,"-")}
    function isValidImageUrl(e){if(!e)return!1;try{return new URL(e),/\.(jpe?g|png|gif|webp|bmp|svg)(\?.*)?$/i.test(e)||/^(https?:\/\/).*\.(jpg|png|gif|webp|bmp|svg)/i.test(e)}catch{return!1}}
    function escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}
    function showNotification(e,t=3e3,a="success"){elements.notificationText.textContent=e,elements.notification.className=`notification ${a}`,elements.notification.classList.add("show"),setTimeout(()=>{elements.notification.classList.remove("show")},t)}
    function debounce(e,t){let a;return function(...o){clearTimeout(a),a=setTimeout(()=>e.apply(this,o),t)}}
    function updateSyncStatus(e,t){elements.syncStatus.className="sync-status",elements.syncStatusText.textContent=t;switch(e){case"syncing":elements.syncStatus.classList.add("syncing"),elements.syncStatusText.innerHTML=`<div class="sync-spinner"></div> ${t}`,elements.forceSyncBtn.style.display="none";break;case"success":elements.syncStatus.classList.add("success"),elements.forceSyncBtn.style.display="inline-block";break;case"error":elements.syncStatus.classList.add("error"),elements.forceSyncBtn.style.display="inline-block";break;case"offline":elements.syncStatus.className="sync-status",elements.forceSyncBtn.style.display="inline-block"}}
    function showAuthModal(){elements.authModal.classList.add("active")}
    function hideAuthModal(){elements.authModal.classList.remove("active")}
    function switchToLogin(){elements.loginTab.classList.add("active"),elements.registerTab.classList.remove("active"),elements.loginForm.classList.add("active"),elements.registerForm.classList.remove("active"),elements.loginError.textContent="",elements.registerError.textContent=""}
    function switchToRegister(){elements.loginTab.classList.remove("active"),elements.registerTab.classList.add("active"),elements.loginForm.classList.remove("active"),elements.registerForm.classList.add("active"),elements.loginError.textContent="",elements.registerError.textContent=""}
    function updateUserProfile(e){e?(currentUser=e,elements.userEmail.textContent=e.email,elements.userAvatar.textContent=e.email.charAt(0).toUpperCase(),elements.appContent.style.display="block",hideAuthModal(),loadUserData(),updateSyncStatus("success","Connesso")):(currentUser=null,elements.appContent.style.display="none",showAuthModal(),updateSyncStatus("offline","Non connesso"))}
    function loadUserData() {
        if (!currentUser) return;
        database.ref(`users/${currentUser.uid}/gameTracker`).once('value').then((snapshot) => {
            const data = snapshot.val();
            if (!data) { renderGames(); return; }
            if (data.games) localStorage.setItem(STORAGE_KEY_GAMES, JSON.stringify(data.games));
            if (data.gameStates) { Object.entries(data.gameStates).forEach(([key, value]) => localStorage.setItem(key, value)); }
            if (data.theme) { localStorage.setItem(THEME_KEY, data.theme); applyTheme(data.theme); }
            renderGames();
        });
    }
    function queueSync(){hasChangesToSync=!0,syncUserData()}
    function forceSync(){const e=Date.now();e-lastForceSyncTime<FORCE_SYNC_COOLDOWN?showNotification(`Aspetta ${Math.ceil((FORCE_SYNC_COOLDOWN-(e-lastForceSyncTime))/1e3)} secondi.`,3e3,"warning"):(lastForceSyncTime=e,syncUserData(!0))}
    const syncUserData = debounce(() => {
        if (!currentUser || isSyncing) { if (!isSyncing) hasChangesToSync = true; return; }
        isSyncing = true;
        hasChangesToSync = false;
        updateSyncStatus("syncing", "Sincronizzazione...");
        try {
            const games = loadCustomGames();
            const gameStates = {};
            gameStates['userEmail'] = currentUser.email; 
            const prefixes = ["played_", "image_", "platinum_", "current_", "lastPlayed_"];
            games.forEach(game => {
                const gameKey = sanitizeKey(game.title);
                prefixes.forEach(prefix => {
                    const item = localStorage.getItem(prefix + gameKey);
                    if (item !== null) { gameStates[prefix + gameKey] = item; }
                });
            });
            const theme = localStorage.getItem(THEME_KEY) || 'dark';
            const dataToSync = { games: games, gameStates: gameStates, theme: theme, lastSync: firebase.database.ServerValue.TIMESTAMP };
            database.ref(`users/${currentUser.uid}/gameTracker`).set(dataToSync)
                .then(() => { updateSyncStatus("success", `Sincronizzato ${new Date().toLocaleTimeString()}`); })
                .catch(error => { console.error("Sync failed:", error); updateSyncStatus("error", "Errore di sincronizzazione"); hasChangesToSync = true; })
                .finally(() => { isSyncing = false; if (hasChangesToSync) { queueSync(); } });
        } catch (error) { console.error("Sync error:", error); updateSyncStatus("error", "Errore di sincronizzazione"); isSyncing = false; hasChangesToSync = true; }
    }, 2000);
    function loadCustomGames(){try{const e=localStorage.getItem("custom_games");return e?JSON.parse(e):[]}catch(e){return console.error("Error loading games:",e),showNotification("Errore nel caricamento dei giochi",4e3,"error"),[]}}
    function saveCustomGames(e){try{localStorage.setItem("custom_games",JSON.stringify(e)),queueSync()}catch(e){console.error("Error saving games:",e),showNotification("Errore nel salvataggio dei giochi",4e3,"error")}}
    function getAllGames() {
      try {
        const games = loadCustomGames();
        const searchTerm = elements.gameSearch.value.toLowerCase();
        const sortValue = elements.sortSelect.value || "name-asc";

        return (searchTerm ? games.filter(game => game.title.toLowerCase().includes(searchTerm)) : games)
          .sort((a, b) => {
            const keyA = sanitizeKey(a.title);
            const keyB = sanitizeKey(b.title);
            
            if (sortValue === "last-played") {
              const timestampA = parseInt(localStorage.getItem(`lastPlayed_${keyA}`)) || 0;
              const timestampB = parseInt(localStorage.getItem(`lastPlayed_${keyB}`)) || 0;
              return timestampB - timestampA;
            }

            const isCurrentA = localStorage.getItem(`current_${keyA}`) === "true";
            const isCurrentB = localStorage.getItem(`current_${keyB}`) === "true";
            if (isCurrentA !== isCurrentB) return isCurrentA ? -1 : 1;

            switch (sortValue) {
              case "name-asc": return a.title.localeCompare(b.title);
              case "name-desc": return b.title.localeCompare(a.title);
              case "played":
                const isPlayedA = localStorage.getItem(`played_${keyA}`) === "true";
                const isPlayedB = localStorage.getItem(`played_${keyB}`) === "true";
                return isPlayedA === isPlayedB ? 0 : isPlayedA ? -1 : 1;
              case "platinum":
                const hasPlatinumA = localStorage.getItem(`platinum_${keyA}`) === "true";
                const hasPlatinumB = localStorage.getItem(`platinum_${keyB}`) === "true";
                return hasPlatinumA === hasPlatinumB ? 0 : hasPlatinumA ? -1 : 1;
              default: return 0;
            }
          });
      } catch (e) { console.error("Error getting games:", e); return []; }
    }
    async function searchIGDBGames(e){try{if(!e||e.length<3)return[];const t=await fetch(IGDB_PROXY,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({search:e})});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const a=await t.json();if(!Array.isArray(a))throw new Error("Invalid response format from IGDB");return a}catch(t){console.error("IGDB Search Error:",t);throw t;}}
    function showAddGameModal(){elements.addGameModal.classList.add("active");elements.modalGameResults.innerHTML=`<div style="color: var(--text-secondary); text-align: center; grid-column: 1 / -1; padding: 2rem; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;"><i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem;"></i>Scrivi almeno 3 caratteri per iniziare la ricerca.</div>`;elements.modalGameSearch.focus()}
    function hideAddGameModal(){elements.addGameModal.classList.remove("active");elements.modalGameSearch.value="";elements.modalGameResults.innerHTML="";elements.modalSubmitGame.disabled=!0;selectedGameForAddition=null}
    function displaySearchResultsInModal(e){const t=elements.modalGameResults;t.innerHTML="";const a=loadCustomGames(),o=new Set(a.map(e=>e.title.toLowerCase()));if(!Array.isArray(e)||0===e.length)return void(t.innerHTML='<div style="color: var(--text-secondary); text-align: center; grid-column: 1 / -1; padding: 2rem;">Nessun risultato trovato.</div>');e.forEach(e=>{const a=o.has(e.name.toLowerCase()),n=document.createElement("div");n.className="game-result-card",a&&n.classList.add("owned");const i=e.cover?.url?`https:${e.cover.url}`:DEFAULT_IMAGE;let r=`<img src="${i}" alt="${escapeHtml(e.name)}" onerror="this.src='${DEFAULT_IMAGE}'"><div class="title">${escapeHtml(e.name)}</div>`;a&&(r+='<div class="owned-badge"><i class="fas fa-check-circle"></i> In libreria</div>'),n.innerHTML=r,a||n.addEventListener("click",()=>{const a=t.querySelector(".selected");a&&a.classList.remove("selected"),n.classList.add("selected"),selectedGameForAddition=e,elements.modalSubmitGame.disabled=!1}),t.appendChild(n)})}
    function setupAddGameModalListeners(){elements.showAddGameModalBtn.addEventListener("click",showAddGameModal),elements.closeAddGameModalBtn.addEventListener("click",hideAddGameModal),elements.addGameModal.addEventListener("click",e=>{e.target===elements.addGameModal&&hideAddGameModal()}),elements.modalGameSearch.addEventListener("input",debounce(async e=>{const t=e.target.value.trim();if(elements.modalSubmitGame.disabled=!0,selectedGameForAddition=null,t.length<3)return void(elements.modalGameResults.innerHTML='<div style="color: var(--text-secondary); text-align: center; grid-column: 1 / -1; padding: 2rem; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;"><i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem;"></i>Scrivi almeno 3 caratteri per iniziare la ricerca.</div>');elements.modalGameResults.innerHTML='<div style="grid-column: 1 / -1;"><div class="loading"><div class="loading-spinner"></div><p>Ricerca in corso...</p></div></div>';try{const e=await searchIGDBGames(t);displaySearchResultsInModal(e)}catch(e){elements.modalGameResults.innerHTML='<div style="color: var(--danger); text-align: center; grid-column: 1 / -1; padding: 2rem;">Si Ã¨ verificato un errore durante la ricerca. Riprova.</div>'}},500)),elements.modalSubmitGame.addEventListener("click",()=>{if(!selectedGameForAddition)return;const e=selectedGameForAddition.name,t=selectedGameForAddition.cover?.url?`https:${selectedGameForAddition.cover.url}`:DEFAULT_IMAGE,a=loadCustomGames();if(a.some(t=>t.title.toLowerCase()===e.toLowerCase()))return void showNotification("Questo gioco Ã¨ giÃ  nella tua libreria.",3e3,"warning");a.push({title:e,image:t}),saveCustomGames(a);const o=sanitizeKey(e);localStorage.setItem(`current_${o}`,"true"),localStorage.setItem(`image_${o}`,t),localStorage.setItem(`lastPlayed_${o}`,Date.now()),showNotification(`"${e}" aggiunto ai giochi in corso!`,3e3,"success"),hideAddGameModal(),renderGames()})}
    function updateStats(){try{const e=getAllGames();let t=e.length,a=0,o=0,n=0,i=0;e.forEach(e=>{const t=sanitizeKey(e.title),r=localStorage.getItem("played_"+t)==="true",s=localStorage.getItem("platinum_"+t)==="true",l=localStorage.getItem("current_"+t)==="true";l?a++:r?n++:o++,s&&i++}),elements.statTotal.textContent=t,elements.statCurrent.textContent=a,elements.statBacklog.textContent=o,elements.statCompleted.textContent=n,elements.statPlatinum.textContent=i}catch(e){console.error("Error updating stats:",e)}}
    function renderGames() {
      try {
        elements.currentGrid.innerHTML = "";
        elements.backlogGrid.innerHTML = "";
        elements.completedGrid.innerHTML = "";
        let currentCount = 0, backlogCount = 0, completedCount = 0;
        getAllGames().forEach(game => {
          const gameEl = document.createElement("div");
          gameEl.className = "game";
          gameEl.dataset.gameTitle = game.title;
          gameEl.setAttribute("aria-label", `Gioco: ${game.title}`);
          const key = sanitizeKey(game.title);
          const isPlayed = localStorage.getItem(`played_${key}`) === "true";
          const imageUrl = localStorage.getItem(`image_${key}`) || game.image;
          const hasPlatinum = localStorage.getItem(`platinum_${key}`) === "true";
          const isCurrent = localStorage.getItem(`current_${key}`) === "true";
          gameEl.innerHTML = `<div class="banner-container">
              <img src="${imageUrl}" alt="${escapeHtml(game.title)}" class="banner" title="Doppio click per cambiare immagine" onerror="this.src='${DEFAULT_IMAGE}'" />
              <div class="game-actions-overlay">
                  <i class="fas fa-copy action-icon copy-btn" title="Copia URL immagine"></i>
                  <i class="fas fa-exchange-alt action-icon move-btn" title="Sposta gioco"></i>
                  <i class="fas fa-times action-icon remove-btn" title="Rimuovi gioco"></i>
              </div>
            </div>
            <div class="info">
              <input type="checkbox" ${isPlayed ? "checked" : ""} title="Segna come giocato" aria-label="Segna come giocato" />
              <div class="game-title" title="${escapeHtml(game.title)}">${escapeHtml(game.title)}</div>
              ${hasPlatinum ? `<img src="${PLATINUM_ICON_URL}" alt="Platino" class="platinum-icon" />` : ""}
            </div>`;
          if (isCurrent) { elements.currentGrid.appendChild(gameEl); currentCount++; }
          else if (isPlayed) { elements.completedGrid.appendChild(gameEl); completedCount++; }
          else { elements.backlogGrid.appendChild(gameEl); backlogCount++; }
          setupGameEventListeners(gameEl, game);
        });
        elements.currentCount.textContent = currentCount;
        elements.backlogCount.textContent = backlogCount;
        elements.completedCount.textContent = completedCount;
        if (currentCount === 0) elements.currentGrid.innerHTML = `<div class="empty-state"><i class="fas fa-gamepad"></i><p>Nessun gioco in corso.<br>Aggiungine uno dalla tua backlog!</p></div>`;
        if (backlogCount === 0) elements.backlogGrid.innerHTML = `<div class="empty-state"><i class="fas fa-list-ul"></i><p>Il tuo backlog Ã¨ vuoto.<br>Aggiungi un nuovo gioco per iniziare.</p></div>`;
        if (completedCount === 0) elements.completedGrid.innerHTML = `<div class="empty-state"><i class="fas fa-trophy"></i><p>Non hai ancora completato nessun gioco.<br>Forza e coraggio!</p></div>`;
        updateStats();
        setupDragAndDrop();
      } catch (e) { console.error("Error rendering games:", e); }
    }
    function setupGameEventListeners(e,t){const a=sanitizeKey(t.title),o=e.querySelector('input[type="checkbox"]');o.addEventListener("change",()=>{localStorage.setItem(`played_${a}`,o.checked.toString()),o.checked&&(localStorage.setItem(`lastPlayed_${a}`,Date.now()),localStorage.removeItem(`current_${a}`)),queueSync(),renderGames()});const n=e.querySelector("img.banner");n.addEventListener("dblclick",e=>{e.preventDefault();const o=localStorage.getItem(`image_${a}`)||t.image,n=prompt(`Inserisci URL per "${t.title}":`,o);n&&isValidImageUrl(n)?(localStorage.setItem(`image_${a}`,n),queueSync(),renderGames()):n&&showNotification("URL non valido.",4e3,"warning")});const i=e.querySelector(".game-title");i.addEventListener("dblclick",()=>{const e=localStorage.getItem(`platinum_${a}`)==="true";localStorage.setItem(`platinum_${a}`,!e),queueSync(),renderGames()}),e.querySelector(".remove-btn").addEventListener("click",e=>{e.stopPropagation(),confirm(`Rimuovere "${t.title}"?`)&&(deleteGame(t.title))}),e.querySelector(".copy-btn").addEventListener("click",e=>{e.stopPropagation();const o=localStorage.getItem(`image_${a}`)||t.image;navigator.clipboard.writeText(o).then(()=>showNotification("URL copiato!"))}),e.querySelector(".move-btn").addEventListener("click",e=>{e.stopPropagation(),showQuickMoveMenu(t,e.target)}),e.addEventListener("contextmenu",e=>{e.preventDefault(),showContextMenu(t,e.clientX,e.clientY)})}
    function showContextMenu(e,t,a){currentContextGame=e,elements.contextMenu.style.display="block";const o=elements.contextMenu.offsetWidth,n=elements.contextMenu.offsetHeight,i=window.innerWidth,r=window.innerHeight,s=Math.min(t,i-o-10),l=Math.min(a,r-n-10);elements.contextMenu.style.left=`${s}px`,elements.contextMenu.style.top=`${l}px`;const c=sanitizeKey(e.title),d=localStorage.getItem(`current_${c}`)==="true",m=document.getElementById("cmToggleCurrent");m.innerHTML=d?'<i class="fas fa-pause-circle"></i><span>Rimuovi da \'in corso\'</span>':'<i class="fas fa-play-circle"></i><span>Aggiungi a \'in corso\'</span>',document.getElementById("cmTogglePlatinum").innerHTML=localStorage.getItem(`platinum_${c}`)==="true"?'<i class="fas fa-trophy"></i><span>Rimuovi platino</span>':'<i class="fas fa-trophy"></i><span>Aggiungi platino</span>'}
    function showQuickMoveMenu(e,t){currentContextGame=e;const a=t.getBoundingClientRect();elements.quickMoveMenu.style.display="block",elements.quickMoveMenu.style.left=`${a.left}px`,elements.quickMoveMenu.style.top=`${a.bottom+5}px`}
    function updateGameName(e,t){if(!t||""===t.trim())return;t=t.trim();const a=loadCustomGames(),o=a.findIndex(t=>t.title===e);if(-1===o)return;const n=sanitizeKey(e),i=sanitizeKey(t);["played_","image_","platinum_","current_","lastPlayed_"].forEach(e=>{const a=localStorage.getItem(e+n);null!==a&&(localStorage.setItem(e+i,a),localStorage.removeItem(e+n))}),a[o].title=t,saveCustomGames(a),renderGames()}
    function deleteGame(e){const t=loadCustomGames().filter(t=>t.title!==e);saveCustomGames(t);const a=sanitizeKey(e);["played_","image_","platinum_","current_","lastPlayed_"].forEach(t=>localStorage.removeItem(t+a)),queueSync(),renderGames(),showNotification(`"${e}" rimosso.`)}
    function moveGameToSection(e,t){const a=sanitizeKey(e);("current"===t||"completed"===t)&&localStorage.setItem(`lastPlayed_${a}`,Date.now()),"current"===t?(localStorage.setItem(`current_${a}`,"true"),localStorage.setItem(`played_${a}`,"false")):"completed"===t?(localStorage.setItem(`played_${a}`,"true"),localStorage.removeItem(`current_${a}`)):(localStorage.setItem(`played_${a}`,"false"),localStorage.removeItem(`current_${a}`)),queueSync(),renderGames()}
    function setupDragAndDrop(){let e=null;document.querySelectorAll(".game").forEach(t=>{t.setAttribute("draggable","true"),t.addEventListener("dragstart",a=>{e=t,t.classList.add("dragging"),a.dataTransfer.setData("text/plain",t.dataset.gameTitle),a.dataTransfer.effectAllowed="move"}),t.addEventListener("dragend",()=>{t.classList.remove("dragging"),document.querySelectorAll(".drop-zone").forEach(e=>e.classList.remove("active"))})}),document.querySelectorAll(".drop-zone").forEach(t=>{t.addEventListener("dragover",t=>{t.preventDefault(),e&&(t.dataTransfer.dropEffect="move",t.classList.add("active"))}),t.addEventListener("dragleave",()=>{t.classList.remove("active")}),t.addEventListener("drop",a=>{a.preventDefault(),t.classList.remove("active");if(!e)return;const o=a.dataTransfer.getData("text/plain"),n=t.id.replace("Grid","");n&&o&&("current"===n?moveGameToSection(o,"current"):"completed"===n?moveGameToSection(o,"completed"):moveGameToSection(o,"backlog"),e=null)})})}
    function applyTheme(e){elements.body.classList.remove("light","dark"),"light"===e?(elements.body.classList.add("light"),elements.themeToggleBtn.textContent="ðŸŒ™",elements.themeToggleBtn.title="Passa a tema scuro"):(elements.body.classList.add("dark"),elements.themeToggleBtn.textContent="â˜€ï¸",elements.themeToggleBtn.title="Passa a tema chiaro"),localStorage.setItem("user_theme",e),queueSync()}
    
    function init() {
      auth.onAuthStateChanged(user => {
        updateUserProfile(user);
      });
      setupEventListeners();
      const savedTheme = localStorage.getItem(THEME_KEY) || 'dark';
      applyTheme(savedTheme);
    }

    function setupEventListeners(){
      elements.loginTab.addEventListener("click",switchToLogin),elements.registerTab.addEventListener("click",switchToRegister),elements.loginBtn.addEventListener("click",()=>{const e=elements.loginEmail.value,t=elements.loginPassword.value;e&&t?(elements.loginBtn.disabled=!0,elements.loginBtnText.innerHTML='<span class="auth-loading"></span> Accesso...',auth.signInWithEmailAndPassword(e,t).catch(e=>{elements.loginError.textContent=getAuthErrorMessage(e),elements.loginBtn.disabled=!1,elements.loginBtnText.textContent="Accedi"})):elements.loginError.textContent="Inserisci email e password"}),elements.registerBtn.addEventListener("click",()=>{const e=elements.registerEmail.value,t=elements.registerPassword.value,a=elements.registerPasswordConfirm.value;e&&t&&a?t!==a?elements.registerError.textContent="Le password non coincidono":t.length<6?elements.registerError.textContent="Minimo 6 caratteri":(elements.registerBtn.disabled=!0,elements.registerBtnText.innerHTML='<span class="auth-loading"></span> Registrazione...',auth.createUserWithEmailAndPassword(e,t).catch(e=>{elements.registerError.textContent=getAuthErrorMessage(e),elements.registerBtn.disabled=!1,elements.registerBtnText.textContent="Registrati"})):elements.registerError.textContent="Compila tutti i campi"}),elements.forgotPasswordLink.addEventListener("click",()=>{const e=elements.loginEmail.value||prompt("Inserisci la tua email:");e&&auth.sendPasswordResetEmail(e).then(()=>showNotification("Email di recupero inviata.",5e3)).catch(e=>{showNotification(getAuthErrorMessage(e),4e3,"error")})}),elements.logoutBtn.addEventListener("click",()=>{auth.signOut().then(()=>showNotification("Disconnessione effettuata")).catch(e=>{showNotification("Errore disconnessione",4e3,"error")})}),elements.themeToggleBtn.addEventListener("click",()=>{const e=elements.body.classList.contains("light")?"dark":"light";applyTheme(e)}),elements.sortSelect.addEventListener("change",renderGames),elements.gameSearch.addEventListener("input",debounce(renderGames,300)),elements.resetBtn.addEventListener("click",()=>{confirm("Resettare il tracker?")&&(localStorage.clear(),saveCustomGames([]),renderGames(),showNotification("Tracker resettato"))}),elements.exportBtn.addEventListener("click",()=>{const e={};e[STORAGE_KEY_GAMES]=localStorage.getItem(STORAGE_KEY_GAMES)||JSON.stringify([]);const t=loadCustomGames();t.forEach(t=>{const a=sanitizeKey(t.title);["played_","image_","platinum_","current_","lastPlayed_"].forEach(o=>{const n=localStorage.getItem(o+a);null!==n&&(e[o+a]=n)})});e[THEME_KEY]=localStorage.getItem(THEME_KEY);const a=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),o=URL.createObjectURL(a),n=document.createElement("a");n.href=o,n.download=`gametracker_backup_${(new Date).toISOString().slice(0,10)}.json`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(o),showNotification("Dati esportati")}),elements.importBtn.addEventListener("click",()=>elements.importFile.click()),elements.importFile.addEventListener("change",e=>{const t=e.target.files[0];if(!t)return;if(t.size>2097152)return void showNotification("File troppo grande (max 2MB)",4e3,"error");const a=new FileReader;a.onload=t=>{try{if(!confirm("Importare? I dati correnti verranno sovrascritti."))return void(e.target.value="");const a=JSON.parse(t.target.result);localStorage.clear(),Object.entries(a).forEach(([e,t])=>localStorage.setItem(e,t)),queueSync(),applyTheme(localStorage.getItem(THEME_KEY)||"dark"),renderGames(),showNotification("Dati importati!")}catch(t){showNotification(`Errore importazione: ${t.message}`,4e3,"error")}finally{e.target.value=""}},a.readAsText(t)}),
      elements.shareBtn.addEventListener('click',()=>{if(!currentUser)return;const e=`${window.location.origin}${window.location.pathname.replace("index.html","")}view.html?user=${currentUser.uid}`;navigator.clipboard.writeText(e).then(()=>showNotification("Link di condivisione copiato!",3e3,"success")).catch(()=>showNotification("Errore copia link.",3e3,"error"))}),
      setupAddGameModalListeners(),document.addEventListener("click",e=>{e.target.closest(".context-menu")||e.target.closest(".game")||(elements.contextMenu.style.display="none"),e.target.closest(".quickMoveMenu")||e.target.classList.contains("move-btn")||(elements.quickMoveMenu.style.display="none")}),document.getElementById("cmRename").addEventListener("click",()=>{if(!currentContextGame)return;const e=prompt("Nuovo nome:",currentContextGame.title);e&&""!==e.trim()&&updateGameName(currentContextGame.title,e.trim()),elements.contextMenu.style.display="none"}),document.getElementById("cmChangeImage").addEventListener("click",()=>{if(!currentContextGame)return;const e="image_"+sanitizeKey(currentContextGame.title),t=localStorage.getItem(e)||currentContextGame.image,a=prompt("Nuovo URL immagine:",t);a&&isValidImageUrl(a)?(localStorage.setItem(e,a),queueSync(),renderGames()):a&&showNotification("URL non valido",3e3,"warning"),elements.contextMenu.style.display="none"}),document.getElementById("cmTogglePlatinum").addEventListener("click",()=>{if(!currentContextGame)return;const e="platinum_"+sanitizeKey(currentContextGame.title),t="true"!==localStorage.getItem(e);localStorage.setItem(e,t.toString()),queueSync(),renderGames(),elements.contextMenu.style.display="none"}),document.getElementById("cmToggleCurrent").addEventListener("click",()=>{if(!currentContextGame)return;const e="current_"+sanitizeKey(currentContextGame.title),t="true"!==localStorage.getItem(e);t?localStorage.setItem(e,"true"):localStorage.removeItem(e),t&&localStorage.removeItem("played_"+sanitizeKey(currentContextGame.title)),queueSync(),renderGames(),elements.contextMenu.style.display="none"}),document.getElementById("cmQuickMove").addEventListener("click",e=>{e.stopPropagation();const t=elements.contextMenu.getBoundingClientRect();elements.quickMoveMenu.style.display="block",elements.quickMoveMenu.style.left=`${t.left+t.width}px`,elements.quickMoveMenu.style.top=`${t.top}px`}),document.querySelectorAll(".move-option").forEach(e=>{e.addEventListener("click",()=>{if(!currentContextGame)return;const t=e.dataset.target;moveGameToSection(currentContextGame.title,t),elements.contextMenu.style.display="none",elements.quickMoveMenu.style.display="none"})}),document.getElementById("cmDelete").addEventListener("click",()=>{currentContextGame&&confirm(`Eliminare "${currentContextGame.title}"?`)&&(deleteGame(currentContextGame.title)),elements.contextMenu.style.display="none"}),document.addEventListener("keydown",e=>{"Escape"===e.key&&(elements.contextMenu.style.display="none",elements.quickMoveMenu.style.display="none",hideAddGameModal())}),elements.forceSyncBtn.addEventListener("click",forceSync)
    }
    
    function getAuthErrorMessage(e){switch(e.code){case"auth/invalid-email":return"Email non valida";case"auth/user-disabled":return"Account disabilitato";case"auth/user-not-found":return"Account non trovato";case"auth/wrong-password":return"Password errata";case"auth/email-already-in-use":return"Email giÃ  in uso";case"auth/weak-password":return"Password troppo debole";default:return"Errore di autenticazione"}}
    
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
